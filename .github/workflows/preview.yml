name: EminXtream Ultimate Pro

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TEMÄ°ZLÄ°K
      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. PACKAGE.JSON (Gerekli Paketler)
      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "fs-extra": "^11.2.0",
              "@expo/vector-icons": "~14.0.0",
              "@react-native-async-storage/async-storage": "2.1.0",
              "expo-localization": "~16.0.0"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # 3. BABEL CONFIG
      - name: âš™ï¸ Babel Config OluÅŸtur
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
            };
          };
          EOF

      # 4. METRO CONFIG
      - name: âš™ï¸ Metro Config OluÅŸtur
        run: |
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config');
          const config = getDefaultConfig(__dirname);
          module.exports = config;
          EOF

      # 5. APP.JS (FULL Ã–ZELLÄ°KLÄ° PREMIUM KOD)
      - name: ðŸ“± App.js OluÅŸtur (Ultimate)
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect, useRef } from 'react';
          import { 
            Text, View, FlatList, SafeAreaView, ActivityIndicator, 
            StatusBar, TouchableOpacity, StyleSheet, Modal, Dimensions, Platform, TextInput, Animated, Easing
          } from 'react-native';
          import { Ionicons } from '@expo/vector-icons';
          import AsyncStorage from '@react-native-async-storage/async-storage';
          import * as Localization from 'expo-localization';

          const URL = "https://imdatgel.site/harem/piyasa_cache.json";
          const { width, height } = Dimensions.get('window');

          // --- DÄ°L PAKETÄ° (Ã‡oklu Dil) ---
          const TRANSLATIONS = {
            tr: {
              title: "Piyasa",
              sub: "CanlÄ± Borsa",
              buy: "ALIÅž",
              sell: "SATIÅž",
              calc: "HESAPLA",
              settings: "Ayarlar",
              darkMode: "Gece Modu",
              language: "Dil / Language",
              amount: "Miktar Girin",
              total: "Toplam Tutar",
              close: "Kapat",
              loading: "Veriler GÃ¼ncelleniyor...",
              adBanner: "Reklam AlanÄ±"
            },
            en: {
              title: "Market",
              sub: "Live Exchange",
              buy: "BUY",
              sell: "SELL",
              calc: "CALCULATE",
              settings: "Settings",
              darkMode: "Dark Mode",
              language: "Language / Dil",
              amount: "Enter Amount",
              total: "Total Value",
              close: "Close",
              loading: "Updating Data...",
              adBanner: "Ad Space"
            }
          };

          export default function App() {
            // --- STATE ---
            const [data, setData] = useState([]);
            const [prevData, setPrevData] = useState({}); // HafÄ±zadan gelen eski fiyatlar
            const [loading, setLoading] = useState(true);
            
            // Ayarlar
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [locale, setLocale] = useState('tr'); // 'tr' veya 'en'
            const t = TRANSLATIONS[locale];

            // UI Kontrolleri
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [selectedCoin, setSelectedCoin] = useState(null); // Hesap makinesi iÃ§in
            const [calcAmount, setCalcAmount] = useState('1'); // Hesaplama miktarÄ±
            const slideAnim = useRef(new Animated.Value(-300)).current; // MenÃ¼ animasyonu

            // --- TEMA ---
            const theme = isDarkMode ? {
              bg: '#0F172A', card: '#1E293B', text: '#F8FAFC', subText: '#94A3B8',
              gold: '#F59E0B', green: '#10B981', red: '#EF4444', border: '#334155',
              modalBg: '#1E293B', inputBg: '#0F172A'
            } : {
              bg: '#F1F5F9', card: '#FFFFFF', text: '#1E293B', subText: '#64748B',
              gold: '#D97706', green: '#059669', red: '#DC2626', border: '#CBD5E1',
              modalBg: '#FFFFFF', inputBg: '#F8FAFC'
            };

            // --- 1. BAÅžLANGIÃ‡ AYARLARI (HafÄ±za) ---
            useEffect(() => {
              loadSettings();
            }, []);

            const loadSettings = async () => {
              try {
                // Dil AyarÄ±
                const savedLang = await AsyncStorage.getItem('appLang');
                if (savedLang) {
                  setLocale(savedLang);
                } else {
                  // Otomatik Dil Tespiti
                  const deviceLang = Localization.locale.split('-')[0]; // "tr-TR" -> "tr"
                  setLocale(deviceLang === 'tr' ? 'tr' : 'en');
                }

                // Tema AyarÄ±
                const savedTheme = await AsyncStorage.getItem('appTheme');
                if (savedTheme !== null) setIsDarkMode(savedTheme === 'true');

                // Ã–nceki Fiyatlar (Ä°breler iÃ§in)
                const savedPrices = await AsyncStorage.getItem('lastPrices');
                if (savedPrices) setPrevData(JSON.parse(savedPrices));
                
                // Verileri Ã‡ek
                loadData();

              } catch (e) {
                console.error("Ayarlar yÃ¼klenemedi", e);
              }
            };

            // --- 2. VERÄ° Ã‡EKME & HAFIZAYA YAZMA ---
            const loadData = async (silent = false) => {
              if (!silent) setLoading(true);
              try {
                const resp = await fetch(URL, { headers: { 'Cache-Control': 'no-cache' } });
                const json = await resp.json();
                
                if (Array.isArray(json)) {
                  // Eski datayÄ± gÃ¼ncellemeden Ã¶nce sakla (AnlÄ±k deÄŸiÅŸim iÃ§in)
                  if (data.length > 0) {
                     const currentMap = {};
                     data.forEach(item => currentMap[item.k] = parseFloat(item.s));
                     setPrevData(currentMap);
                  }

                  setData(json);

                  // FiyatlarÄ± HafÄ±zaya Yaz (Uygulama kapanÄ±nca unutmasÄ±n diye)
                  const priceMap = {};
                  json.forEach(item => priceMap[item.k] = parseFloat(item.s));
                  await AsyncStorage.setItem('lastPrices', JSON.stringify(priceMap));
                }
              } catch (e) {
                console.log(e);
              } finally {
                setLoading(false);
              }
            };

            // 30 Saniye DÃ¶ngÃ¼sÃ¼
            useEffect(() => {
              const timer = setInterval(() => loadData(true), 30000);
              return () => clearInterval(timer);
            }, [data]); // Data deÄŸiÅŸince timer'Ä± yenileme, interval sabit kalsÄ±n ama burada dependency yÃ¶netimi Ã¶nemli deÄŸil.

            // --- 3. MENÃœ & DÄ°L Ä°ÅžLEMLERÄ° ---
            const toggleMenu = () => {
              const toValue = isMenuOpen ? -300 : 0;
              Animated.timing(slideAnim, {
                toValue, duration: 300, useNativeDriver: true, easing: Easing.ease
              }).start();
              setIsMenuOpen(!isMenuOpen);
            };

            const changeLang = async (lang) => {
              setLocale(lang);
              await AsyncStorage.setItem('appLang', lang);
            };

            const toggleTheme = async () => {
              const newVal = !isDarkMode;
              setIsDarkMode(newVal);
              await AsyncStorage.setItem('appTheme', String(newVal));
            };

            // --- 4. HESAPLAMA MANTIÄžI ---
            const openCalculator = (item) => {
              setSelectedCoin(item);
              setCalcAmount('1'); // VarsayÄ±lan 1 adet
            };

            const calculateTotal = () => {
              if (!selectedCoin || !calcAmount) return "0.00";
              const price = parseFloat(selectedCoin.s);
              const amount = parseFloat(calcAmount.replace(',', '.'));
              if (isNaN(amount)) return "0.00";
              return (price * amount).toFixed(2);
            };

            // --- 5. UI BÄ°LEÅžENLERÄ° ---
            const getTrend = (symbol, currentPriceStr) => {
              const current = parseFloat(currentPriceStr);
              const prev = prevData[symbol];
              
              if (!prev) return { icon: 'remove', color: theme.subText };
              if (current > prev) return { icon: 'caret-up', color: theme.green };
              if (current < prev) return { icon: 'caret-down', color: theme.red };
              return { icon: 'remove', color: theme.subText };
            };

            const renderItem = ({ item }) => {
              const trend = getTrend(item.k, item.s);
              return (
                <TouchableOpacity onPress={() => openCalculator(item)} activeOpacity(0.7)>
                  <View style={[styles.card, { backgroundColor: theme.card, borderColor: theme.border }]}>
                    <View style={{flexDirection:'row', alignItems:'center'}}>
                      <View style={[styles.iconBox, { backgroundColor: isDarkMode ? 'rgba(245,158,11,0.2)' : 'rgba(217,119,6,0.1)' }]}>
                        <Text style={{fontSize:18, fontWeight:'bold', color: theme.gold}}>{item.k.charAt(0)}</Text>
                      </View>
                      <View>
                        <Text style={{color: theme.text, fontWeight:'bold', fontSize:16}}>{item.k.replace('_', ' ')}</Text>
                        <Text style={{color: theme.subText, fontSize:11}}>{item.t?.split(' ')[1]}</Text>
                      </View>
                    </View>
                    <View style={{alignItems:'flex-end'}}>
                      <View style={{flexDirection:'row', alignItems:'center'}}>
                        <Text style={{color: theme.text, fontSize:18, fontWeight:'bold', marginRight:5}}>{parseFloat(item.s).toFixed(2)}</Text>
                        <Ionicons name={trend.icon} size={20} color={trend.color} />
                      </View>
                      <Text style={{color: theme.subText, fontSize:11}}>{t.buy}: {parseFloat(item.a).toFixed(2)}</Text>
                    </View>
                  </View>
                </TouchableOpacity>
              );
            };

            return (
              <SafeAreaView style={[styles.container, { backgroundColor: theme.bg }]}>
                <StatusBar barStyle={isDarkMode ? "light-content" : "dark-content"} />

                {/* HEADER */}
                <View style={[styles.header, { borderBottomColor: theme.border }]}>
                  <TouchableOpacity onPress={toggleMenu} style={{padding:5}}>
                    <Ionicons name="menu" size={28} color={theme.text} />
                  </TouchableOpacity>
                  <View style={{alignItems:'center'}}>
                    <Text style={[styles.headerTitle, { color: theme.text }]}>{t.title}<Text style={{color: theme.gold}}>Pro</Text></Text>
                  </View>
                  <View style={{width:28}} /> 
                </View>

                {/* Ä°Ã‡ERÄ°K */}
                {loading && !data.length ? (
                  <View style={styles.center}><ActivityIndicator size="large" color={theme.gold} /></View>
                ) : (
                  <FlatList
                    data={data}
                    keyExtractor={(item) => item.k}
                    renderItem={renderItem}
                    contentContainerStyle={{paddingBottom: 80, paddingTop: 10}}
                  />
                )}

                {/* --- SIDEBAR MENU --- */}
                {isMenuOpen && (
                  <TouchableOpacity style={styles.menuOverlay} onPress={toggleMenu} activeOpacity={1}>
                    <Animated.View style={[styles.sidebar, { backgroundColor: theme.card, transform: [{ translateX: slideAnim }] }]}>
                       <View style={{padding:20, borderBottomWidth:1, borderColor: theme.border, marginBottom:20}}>
                         <Text style={{fontSize:24, fontWeight:'bold', color: theme.gold}}>Ayarlar</Text>
                       </View>

                       {/* Tema DeÄŸiÅŸtir */}
                       <TouchableOpacity onPress={toggleTheme} style={styles.menuItem}>
                         <Ionicons name={isDarkMode ? "moon" : "sunny"} size={24} color={theme.text} />
                         <Text style={[styles.menuText, { color: theme.text }]}>{t.darkMode}</Text>
                         <View style={[styles.toggle, { backgroundColor: isDarkMode ? theme.green : '#CCC' }]}>
                           <View style={[styles.toggleBall, { transform: [{ translateX: isDarkMode ? 20 : 0 }] }]} />
                         </View>
                       </TouchableOpacity>

                       {/* Dil DeÄŸiÅŸtir */}
                       <View style={styles.menuItem}>
                         <Ionicons name="language" size={24} color={theme.text} />
                         <Text style={[styles.menuText, { color: theme.text }]}>{t.language}</Text>
                       </View>
                       <View style={{flexDirection:'row', justifyContent:'space-around', paddingHorizontal:20}}>
                          <TouchableOpacity onPress={() => changeLang('tr')} style={[styles.langBtn, locale === 'tr' && {borderColor: theme.gold, borderWidth:2}]}>
                            <Text style={{color: theme.text}}>ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e</Text>
                          </TouchableOpacity>
                          <TouchableOpacity onPress={() => changeLang('en')} style={[styles.langBtn, locale === 'en' && {borderColor: theme.gold, borderWidth:2}]}>
                            <Text style={{color: theme.text}}>ðŸ‡ºðŸ‡¸ English</Text>
                          </TouchableOpacity>
                       </View>

                       <View style={{flex:1}} />
                       <Text style={{textAlign:'center', color: theme.subText, marginBottom:20}}>v1.0.0 App Store</Text>
                    </Animated.View>
                  </TouchableOpacity>
                )}

                {/* --- HESAP MAKÄ°NESÄ° MODAL --- */}
                <Modal visible={!!selectedCoin} transparent={true} animationType="slide">
                  <View style={styles.modalOverlay}>
                    <View style={[styles.calcBox, { backgroundColor: theme.modalBg }]}>
                       <View style={{flexDirection:'row', justifyContent:'space-between', alignItems:'center', marginBottom:20}}>
                         <Text style={{fontSize:20, fontWeight:'bold', color: theme.text}}>
                           {selectedCoin?.k.replace('_', ' ')} {t.calc}
                         </Text>
                         <TouchableOpacity onPress={() => setSelectedCoin(null)}>
                           <Ionicons name="close-circle" size={30} color={theme.subText} />
                         </TouchableOpacity>
                       </View>

                       <Text style={{color: theme.subText, marginBottom:5}}>{t.amount}:</Text>
                       <TextInput 
                         style={[styles.input, { backgroundColor: theme.inputBg, color: theme.text, borderColor: theme.border }]}
                         keyboardType="numeric"
                         value={calcAmount}
                         onChangeText={setCalcAmount}
                       />

                       <View style={{marginVertical:20, padding:15, backgroundColor: theme.inputBg, borderRadius:10}}>
                         <Text style={{color: theme.subText, textAlign:'center'}}>{t.total}</Text>
                         <Text style={{color: theme.gold, fontSize:28, fontWeight:'bold', textAlign:'center'}}>
                           {calculateTotal()} â‚º
                         </Text>
                       </View>

                       <TouchableOpacity onPress={() => setSelectedCoin(null)} style={{backgroundColor: theme.gold, padding:15, borderRadius:10}}>
                         <Text style={{color:'#000', fontWeight:'bold', textAlign:'center'}}>{t.close}</Text>
                       </TouchableOpacity>
                    </View>
                  </View>
                </Modal>

                {/* BANNER (TEST) */}
                <View style={{alignItems:'center', padding:10, borderTopWidth:1, borderColor: theme.border}}>
                  <Text style={{color: theme.subText, fontSize:10}}>{t.adBanner}</Text>
                </View>

              </SafeAreaView>
            );
          }

          const styles = StyleSheet.create({
            container: { flex: 1 },
            center: { flex: 1, justifyContent: 'center', alignItems: 'center' },
            header: {
              flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center',
              paddingHorizontal: 20, paddingVertical: 15, borderBottomWidth: 1
            },
            headerTitle: { fontSize: 22, fontWeight: '800' },
            card: {
              flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center',
              padding: 16, marginHorizontal: 16, marginBottom: 12, borderRadius: 16,
              borderWidth: 1, shadowColor: "#000", shadowOffset: {width:0, height:2}, shadowOpacity:0.1, elevation:3
            },
            iconBox: { width: 40, height: 40, borderRadius: 12, justifyContent:'center', alignItems:'center', marginRight:12 },
            
            // Sidebar
            menuOverlay: { position: 'absolute', top: 0, bottom: 0, left: 0, right: 0, backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 10 },
            sidebar: { width: 300, height: '100%', paddingTop: 50 },
            menuItem: { flexDirection: 'row', alignItems: 'center', padding: 20, justifyContent:'space-between' },
            menuText: { fontSize: 18, marginLeft: 15, flex:1 },
            toggle: { width: 50, height: 30, borderRadius: 15, padding: 2 },
            toggleBall: { width: 26, height: 26, borderRadius: 13, backgroundColor: '#FFF' },
            langBtn: { padding: 10, backgroundColor: 'rgba(128,128,128,0.2)', borderRadius: 8, width:'45%', alignItems:'center' },

            // Calculator
            modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.8)', justifyContent: 'center', alignItems: 'center' },
            calcBox: { width: '90%', padding: 20, borderRadius: 20 },
            input: { padding: 15, borderRadius: 10, borderWidth: 1, fontSize: 18, fontWeight: 'bold' }
          });
          EOF

      # 6. APP.JSON
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "Piyasa Pro",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "automatic",
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "infoPlist": {
                  "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true }
                }
              },
              "android": {
                "package": "com.piyasapro.app"
              },
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": { "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" } }
            }
          }
          EOF

      - name: ðŸ–¼ Assets OluÅŸtur
        run: |
          mkdir -p assets
          touch assets/icon.png assets/splash.png assets/adaptive-icon.png assets/favicon.png

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      - name: ðŸš€ GÃ¶nder
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "Ultimate Pro: SideMenu & Calc" --non-interactive
