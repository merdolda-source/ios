name: EminXtream Firebase Re-Enable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: üèó Depoyu √áek
        uses: actions/checkout@v4

      # 1. TEMƒ∞ZLƒ∞K
      - name: üßπ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist google-services.json

      - name: üèó Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. FIREBASE Kƒ∞MLƒ∞K DOSYASI (iOS ƒ∞√ßin ≈ûART)
      # ƒ∞lk mesajƒ±nda verdiƒüin bilgileri buraya g√∂m√ºyoruz.
      - name: üìÑ GoogleService-Info.plist Olu≈ütur
        run: |
          cat > GoogleService-Info.plist <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>API_KEY</key>
            <string>AIzaSyAlrmsDBxfxLgFXaWGem26zW4ow6MtuE6s</string>
            <key>GCM_SENDER_ID</key>
            <string>1049874203126</string>
            <key>PLIST_VERSION</key>
            <string>1</string>
            <key>BUNDLE_ID</key>
            <string>com.piyasapro.app</string>
            <key>PROJECT_ID</key>
            <string>piayasa</string>
            <key>STORAGE_BUCKET</key>
            <string>piayasa.firebasestorage.app</string>
            <key>IS_ADS_ENABLED</key>
            <false/>
            <key>IS_ANALYTICS_ENABLED</key>
            <false/>
            <key>IS_APPINVITE_ENABLED</key>
            <true/>
            <key>IS_GCM_ENABLED</key>
            <true/>
            <key>IS_SIGNIN_ENABLED</key>
            <true/>
            <key>GOOGLE_APP_ID</key>
            <string>1:1049874203126:ios:d23a155d59992ec68e07d7</string>
          </dict>
          </plist>
          EOF

      # Android i√ßin bo≈ü bir placeholder (Hata vermesin diye)
      - name: üìÑ google-services.json (Placeholder)
        run: echo "{}" > google-services.json

      # 3. PACKAGE.JSON (Firebase'i Geri Ekledik)
      - name: üìÑ package.json Olu≈ütur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "fs-extra": "^11.2.0",
              "@react-native-firebase/app": "21.6.1",
              "@react-native-firebase/remote-config": "21.6.1"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # 4. BABEL CONFIG (√áalƒ±≈üan Yapƒ±)
      - name: ‚öôÔ∏è Babel Config Olu≈ütur
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
            };
          };
          EOF

      # 5. METRO CONFIG (Firebase Uyumlu)
      - name: ‚öôÔ∏è Metro Config Olu≈ütur
        run: |
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config');
          const config = getDefaultConfig(__dirname);
          config.resolver.sourceExts.push('cjs');
          module.exports = config;
          EOF

      # 6. APP.JS (Hem Firebase Hem Yedek Link)
      - name: üì± App.js Olu≈ütur
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect } from 'react';
          import { Text, View, FlatList, SafeAreaView, ActivityIndicator, StatusBar, TouchableOpacity } from 'react-native';
          import remoteConfig from '@react-native-firebase/remote-config';

          // YEDEK Lƒ∞NK (Firebase √ßalƒ±≈ümazsa burasƒ± devreye girer)
          const FALLBACK_URL = "https://imdatgel.site/harem/piyasa_cache.json";

          export default function App() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [status, setStatus] = useState("Ba≈ülatƒ±lƒ±yor...");

            const loadData = async () => {
              setLoading(true);
              setStatus("Veriler g√ºncelleniyor...");
              
              let targetUrl = FALLBACK_URL;

              try {
                // 1. FIREBASE DENEMESƒ∞
                try {
                  await remoteConfig().setConfigSettings({ minimumFetchIntervalMillis: 0 });
                  await remoteConfig().setDefaults({ json_url: FALLBACK_URL });
                  await remoteConfig().fetchAndActivate();
                  
                  const remoteVal = remoteConfig().getValue('json_url').asString();
                  if (remoteVal && remoteVal.startsWith('http')) {
                    targetUrl = remoteVal;
                    // console.log("Firebase URL kullanƒ±lƒ±yor:", targetUrl);
                  }
                } catch (fbError) {
                  console.log("Firebase hatasƒ±, yedek linke ge√ßiliyor.");
                }

                // 2. VERƒ∞ √áEKME
                const resp = await fetch(targetUrl, { headers: { 'Cache-Control': 'no-cache' } });
                if (!resp.ok) throw new Error("Sunucu Hatasƒ±: " + resp.status);
                
                const json = await resp.json();
                if (Array.isArray(json)) {
                  setData(json);
                  setStatus(""); // Hata yoksa mesajƒ± temizle
                } else {
                  setStatus("Veri formatƒ± hatalƒ±");
                }
              } catch (e) {
                setStatus("HATA: " + e.message);
              } finally {
                setLoading(false);
              }
            };

            useEffect(() => { 
              // 1 saniye gecikmeli ba≈ülat (Firebase native mod√ºl√ºn√ºn y√ºklenmesi i√ßin)
              setTimeout(loadData, 1000); 
            }, []);

            return (
              <SafeAreaView style={{flex:1, backgroundColor:'#000', paddingTop:40}}>
                <StatusBar barStyle="light-content" />
                <View style={{padding:20, borderBottomWidth:1, borderColor:'#333', flexDirection:'row', justifyContent:'space-between'}}>
                  <Text style={{color:'#FFD60A', fontSize:24, fontWeight:'bold'}}>Piyasa Pro</Text>
                  <TouchableOpacity onPress={loadData} style={{backgroundColor:'#333', padding:10, borderRadius:5}}>
                     <Text style={{color:'#FFF'}}>YENƒ∞LE</Text>
                  </TouchableOpacity>
                </View>

                {status ? <Text style={{color:'red', textAlign:'center', margin:20, fontSize:12}}>{status}</Text> : null}

                {loading ? <ActivityIndicator size="large" color="#FFD60A" style={{marginTop:20}} /> : (
                  <FlatList
                    data={data}
                    keyExtractor={(item, index) => index.toString()}
                    renderItem={({ item }) => (
                      <View style={{flexDirection:'row', justifyContent:'space-between', padding:16, borderBottomWidth:1, borderColor:'#222'}}>
                        <View>
                          <Text style={{color:'#FFF', fontSize:16, fontWeight:'bold'}}>{item.k}</Text>
                          <Text style={{color:'#888'}}>{item.t?.split(' ')[1]}</Text>
                        </View>
                        <View style={{alignItems:'flex-end'}}>
                           <Text style={{color:'#FFD60A', fontSize:18, fontWeight:'bold'}}>{item.s}</Text>
                           <Text style={{color:'#888'}}>Alƒ±≈ü: {item.a}</Text>
                        </View>
                      </View>
                    )}
                  />
                )}
              </SafeAreaView>
            );
          }
          EOF

      # 7. APP.JSON (Firebase Plugin Aktif)
      - name: üìÑ app.json Olu≈ütur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "Piyasa Pro",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "dark",
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "googleServicesFile": "./GoogleService-Info.plist",
                "infoPlist": { "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true } }
              },
              "android": { 
                "package": "com.piyasapro.app",
                "googleServicesFile": "./google-services.json"
              },
              "plugins": [
                "@react-native-firebase/app"
              ],
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": { "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" } }
            }
          }
          EOF

      - name: üñº Assets Olu≈ütur
        run: |
          mkdir -p assets
          touch assets/icon.png assets/splash.png assets/adaptive-icon.png assets/favicon.png

      - name: üì¶ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      - name: üöÄ G√∂nder
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "Firebase Re-Enabled" --non-interactive
