name: EminXtream iOS BUILD (IPA)

on:
  workflow_dispatch: # Bu iÅŸlemi sadece sen butona basÄ±nca baÅŸlatÄ±r (Otomatik Ã§alÄ±ÅŸmaz, Ã§Ã¼nkÃ¼ build hakkÄ±n sÄ±nÄ±rlÄ±)

jobs:
  build-ios:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TEMÄ°ZLÄ°K
      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. CONFIG DOSYALARI

      # A) PACKAGE.JSON (GerÃ§ek AdMob KÃ¼tÃ¼phanesi Dahil)
      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "fs-extra": "^11.2.0",
              "@expo/vector-icons": "~14.0.0",
              "react-native-google-mobile-ads": "^13.0.0",
              "react-native-safe-area-context": "4.12.0",
              "expo-build-properties": "~0.12.0"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # B) EAS.JSON (Build AyarlarÄ± - Ã–NEMLÄ°)
      - name: ðŸ“„ eas.json OluÅŸtur
        run: |
          cat > eas.json <<'EOF'
          {
            "cli": {
              "version": ">= 10.0.0"
            },
            "build": {
              "preview": {
                "distribution": "internal",
                "ios": {
                  "simulator": false
                }
              },
              "production": {
                "ios": {
                  "resourceClass": "medium"
                }
              }
            }
          }
          EOF

      # C) APP.JS (GerÃ§ek AdMob Entegrasyonu)
      - name: ðŸ“± App.js OluÅŸtur
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect } from 'react';
          import { 
            Text, View, FlatList, ActivityIndicator, StatusBar, TouchableOpacity, 
            StyleSheet, Modal, Platform, TextInput, Keyboard, RefreshControl, 
            KeyboardAvoidingView 
          } from 'react-native';
          import { Ionicons } from '@expo/vector-icons';
          import { SafeAreaProvider, useSafeAreaInsets } from 'react-native-safe-area-context';
          // GERÃ‡EK ADMOB KÃœTÃœPHANESÄ°
          import { BannerAd, BannerAdSize, InterstitialAd, AdEventType, TestIds } from 'react-native-google-mobile-ads';

          // --- REKLAM ID'LERÄ° ---
          // NOT: Build alÄ±rken gerÃ§ek ID kullanmak bazen risklidir (banlanma riski).
          // Ä°lk denemede TestIds.BANNER kullanÄ±p, Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rÃ¼nce gerÃ§ek ID'ye geÃ§mek daha saÄŸlÄ±klÄ±dÄ±r.
          // Åžimdilik senin verdiÄŸin gerÃ§ek ID'leri koyuyorum.
          const BANNER_ID = "ca-app-pub-2289573527937577/9217874142";
          const INTERSTITIAL_ID = "ca-app-pub-2289573527937577/6951577531";
          const URL = "https://imdatgel.site/harem/piyasa_cache.json";

          const interstitial = InterstitialAd.createForAdRequest(INTERSTITIAL_ID, {
            requestNonPersonalizedAdsOnly: true,
          });

          function MainApp() {
            const insets = useSafeAreaInsets();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [interstitialLoaded, setInterstitialLoaded] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [currentTime, setCurrentTime] = useState("");
            
            // Hesap Makinesi
            const [calcVisible, setCalcVisible] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [amount, setAmount] = useState('');
            const [calcResult, setCalcResult] = useState(null);

            const theme = isDarkMode ? {
              bg: '#0F172A', card: '#1E293B', text: '#F8FAFC', subText: '#94A3B8',
              gold: '#F59E0B', green: '#10B981', red: '#EF4444', border: '#334155',
              modal: '#1E293B', input: '#334155'
            } : {
              bg: '#F1F5F9', card: '#FFFFFF', text: '#1E293B', subText: '#64748B',
              gold: '#D97706', green: '#059669', red: '#DC2626', border: '#E2E8F0',
              modal: '#FFFFFF', input: '#F1F5F9'
            };

            useEffect(() => {
              const unsubscribeLoaded = interstitial.addAdEventListener(AdEventType.LOADED, () => {
                setInterstitialLoaded(true);
              });
              const unsubscribeClosed = interstitial.addAdEventListener(AdEventType.CLOSED, () => {
                setInterstitialLoaded(false);
                interstitial.load();
              });
              interstitial.load();
              
              const timer = setInterval(() => setCurrentTime(new Date().toLocaleTimeString('tr-TR')), 1000);
              return () => {
                unsubscribeLoaded();
                unsubscribeClosed();
                clearInterval(timer);
              };
            }, []);

            const loadData = async (isAuto = false) => {
              if (!isAuto) setLoading(true);
              try {
                const resp = await fetch(URL, { headers: { 'Cache-Control': 'no-cache' } });
                const json = await resp.json();
                if (Array.isArray(json)) {
                  setData(json);
                  // Rastgele reklam gÃ¶sterimi (her yenilemede %25 ÅŸans)
                  if (Math.random() < 0.25 && interstitialLoaded) {
                     interstitial.show();
                  }
                }
              } catch (e) { console.error(e); } 
              finally { setLoading(false); setRefreshing(false); }
            };

            useEffect(() => { loadData(); }, []);

            const onRefresh = () => { setRefreshing(true); loadData(true); };

            const openCalculator = (item) => {
              setSelectedItem(item);
              setAmount('');
              setCalcResult(null);
              setCalcVisible(true);
            };

            const handleCalculate = (text) => {
              setAmount(text);
              if (selectedItem && text) {
                const val = parseFloat(text.replace(',', '.'));
                const price = parseFloat(selectedItem.s);
                if (!isNaN(val)) setCalcResult((val * price).toFixed(2));
              }
            };

            const renderItem = ({ item }) => (
              <TouchableOpacity onPress={() => openCalculator(item)} activeOpacity={0.7}>
                <View style={[styles.card, { backgroundColor: theme.card, borderColor: theme.border }]}>
                  <View>
                     <Text style={{color: theme.text, fontWeight:'bold', fontSize:16}}>{item.k.replace('_', ' ')}</Text>
                     <Text style={{color: theme.subText, fontSize:11}}>{item.t?.split(' ')[1]}</Text>
                  </View>
                  <View style={{alignItems:'flex-end'}}>
                     <Text style={{color: theme.text, fontSize:18, fontWeight:'bold'}}>{parseFloat(item.s).toFixed(2)}</Text>
                     <Text style={{color: theme.subText, fontSize:12}}>AlÄ±ÅŸ: {parseFloat(item.a).toFixed(2)}</Text>
                  </View>
                </View>
              </TouchableOpacity>
            );

            return (
              <View style={[styles.container, { backgroundColor: theme.bg, paddingTop: insets.top }]}>
                <StatusBar barStyle={isDarkMode ? "light-content" : "dark-content"} />
                
                {/* HEADER */}
                <View style={[styles.header, { borderBottomColor: theme.border }]}>
                   <Text style={[styles.title, { color: theme.text }]}>Piyasa<Text style={{color: theme.gold}}>Pro</Text></Text>
                   <View style={{flexDirection:'row', alignItems:'center'}}>
                      <Text style={[styles.clock, { color: theme.gold, backgroundColor: isDarkMode ? '#1E293B' : '#E2E8F0' }]}>{currentTime}</Text>
                      <TouchableOpacity onPress={() => setIsDarkMode(!isDarkMode)} style={{marginLeft:10}}>
                        <Ionicons name={isDarkMode ? "sunny" : "moon"} size={24} color={theme.text} />
                      </TouchableOpacity>
                   </View>
                </View>

                {/* LISTE */}
                {loading ? <ActivityIndicator size="large" color={theme.gold} style={{marginTop:20}} /> : (
                  <FlatList
                    data={data}
                    keyExtractor={item => item.k}
                    renderItem={renderItem}
                    refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={theme.gold} />}
                    contentContainerStyle={{paddingBottom: 60}}
                  />
                )}

                {/* REKLAM BANNER */}
                <View style={{alignItems:'center', borderTopWidth:1, borderColor:theme.border, paddingBottom: Platform.OS === 'ios' ? insets.bottom : 0 }}>
                  <BannerAd
                    unitId={BANNER_ID}
                    size={BannerAdSize.ANCHORED_ADAPTIVE_BANNER}
                  />
                </View>

                {/* HESAP MAKÄ°NESÄ° */}
                <Modal visible={calcVisible} transparent={true} animationType="slide" onRequestClose={() => setCalcVisible(false)}>
                  <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={styles.modalOverlay}>
                    <TouchableOpacity style={{flex:1, justifyContent:'center', alignItems:'center', width:'100%'}} activeOpacity={1} onPress={Keyboard.dismiss}>
                       <View style={[styles.calcContent, { backgroundColor: theme.modal, borderColor: theme.gold }]}>
                          <View style={{flexDirection:'row', justifyContent:'space-between', marginBottom:20}}>
                             <Text style={{color:theme.text, fontSize:18, fontWeight:'bold'}}>Hesapla</Text>
                             <TouchableOpacity onPress={() => setCalcVisible(false)}>
                                <Ionicons name="close-circle" size={30} color={theme.red} />
                             </TouchableOpacity>
                          </View>
                          <Text style={{color: theme.gold, fontSize:22, fontWeight:'bold', marginBottom:15}}>{selectedItem?.s} â‚º</Text>
                          <TextInput 
                             style={[styles.input, { backgroundColor: theme.input, color: theme.text, borderColor: theme.border }]}
                             placeholder="Miktar" placeholderTextColor={theme.subText} keyboardType="numeric"
                             value={amount} onChangeText={handleCalculate}
                          />
                          {calcResult && (
                             <View style={{marginTop:20, padding:15, backgroundColor: theme.green, borderRadius:12, alignItems:'center'}}>
                                <Text style={{color:'#FFF', fontSize:26, fontWeight:'900'}}>{calcResult} â‚º</Text>
                             </View>
                          )}
                       </View>
                    </TouchableOpacity>
                  </KeyboardAvoidingView>
                </Modal>
              </View>
            );
          }

          export default function App() {
            return (
              <SafeAreaProvider>
                <MainApp />
              </SafeAreaProvider>
            );
          }

          const styles = StyleSheet.create({
            container: { flex: 1 },
            header: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', padding: 15, borderBottomWidth: 1 },
            title: { fontSize: 24, fontWeight: '800' },
            clock: { fontSize: 13, fontWeight: 'bold', padding: 6, borderRadius: 6, overflow: 'hidden' },
            card: { flexDirection: 'row', justifyContent: 'space-between', padding: 16, marginHorizontal: 16, marginBottom: 10, borderRadius: 16, borderWidth: 1 },
            modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.7)', justifyContent: 'center' },
            calcContent: { width: '90%', padding: 20, borderRadius: 24, borderWidth: 1, elevation: 10 },
            input: { height: 50, borderRadius: 12, paddingHorizontal: 15, borderWidth: 1, fontSize: 18 }
          });
          EOF

      # D) APP.JSON (PLUGIN AÃ‡IK - IPA Ä°Ã‡Ä°N ÅžART)
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "Piyasa Pro",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "automatic",
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "supportsTablet": true,
                "config": {
                  "googleMobileAdsAppId": "ca-app-pub-2289573527937577~7422350827"
                }
              },
              "android": {
                "package": "com.piyasapro.app",
                "config": {
                   "googleMobileAdsAppId": "ca-app-pub-2289573527937577~7422350827"
                }
              },
              "plugins": [
                [
                  "react-native-google-mobile-ads",
                  {
                    "androidAppId": "ca-app-pub-2289573527937577~7422350827",
                    "iosAppId": "ca-app-pub-2289573527937577~7422350827"
                  }
                ],
                "expo-build-properties"
              ],
              "extra": { "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" } }
            }
          }
          EOF

      - name: âš™ï¸ Babel Config OluÅŸtur
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
            };
          };
          EOF
      
      - name: âš™ï¸ Metro Config OluÅŸtur
        run: |
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config');
          const config = getDefaultConfig(__dirname);
          module.exports = config;
          EOF

      - name: ðŸ–¼ Assets OluÅŸtur
        run: |
          mkdir -p assets
          touch assets/icon.png assets/splash.png assets/adaptive-icon.png assets/favicon.png

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      # --- Ä°ÅžTE SÄ°HÄ°RLÄ° KOMUT BURASI ---
      # ArtÄ±k 'update' deÄŸil 'build' yapÄ±yoruz.
      # non-interactive: Apple hesabÄ±nÄ± sormadan, Ã¶nceden tanÄ±mlÄ± hesabÄ± kullanÄ±r.
      - name: ðŸ— IPA OluÅŸtur (Build)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform ios --profile preview --non-interactive
