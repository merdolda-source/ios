name: ANLIK PÄ°YASA - FINAL API FIX

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      do_build:
        description: "EAS build alsÄ±n mÄ±? (true/false)"
        required: false
        default: "false"

jobs:
  publish-api-fix:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TEMÄ°ZLÄ°K
      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist credentials.json

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. GÃ–RSELLER
      - name: ðŸŽ¨ GÃ¶rselleri OluÅŸtur
        run: |
          sudo apt-get update -y
          sudo apt-get install imagemagick -y
          mkdir -p assets

          # Ä°kon
          curl -L -o assets/icon.png "https://i.ibb.co/99mj6zkx/71cf52be-22d6-4382-8a4e-bb42ea43796e.png"

          # Splash
          convert -size 1242x2688 xc:"#000000" \
            -fill "#F59E0B" -font DejaVu-Sans-Bold -gravity center -pointsize 100 -annotate 0 "ANLIK PÄ°YASA" \
            assets/splash.png

          cp assets/icon.png assets/adaptive-icon.png
          cp assets/icon.png assets/favicon.png

      # 3. PACKAGE.JSON (Favori + Alarm + Push + Grafik)
      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "anlikpiyasa",
            "version": "1.1.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "fs-extra": "^11.2.0",
              "@expo/vector-icons": "~14.0.0",
              "react-native-safe-area-context": "4.12.0",
              "react-native-reanimated": "~3.6.1",

              "expo-notifications": "~0.30.7",
              "expo-device": "~7.1.0",
              "expo-constants": "~17.1.6",
              "@react-native-async-storage/async-storage": "1.24.0",
              "react-native-svg": "15.7.1"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # 4. CONFIG DOSYALARI
      - name: âš™ï¸ Config DosyalarÄ±
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
              plugins: ['react-native-reanimated/plugin']
            };
          };
          EOF

          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config');
          const config = getDefaultConfig(__dirname);
          module.exports = config;
          EOF

          # EAS profilleri (update + build)
          cat > eas.json <<'EOF'
          {
            "build": {
              "preview": {
                "distribution": "internal",
                "ios": { "simulator": false }
              },
              "production": {
                "autoIncrement": true
              }
            },
            "submit": {
              "production": {}
            }
          }
          EOF

      # 5. APP.JS (Favoriler + Alarm + Push AltyapÄ± + Sparkline + Pro Mode)
      - name: ðŸ“± App.js OluÅŸtur
        run: |
          cat > App.js <<'EOF'
          import React, { useEffect, useMemo, useRef, useState } from 'react';
          import {
            Text, View, FlatList, ActivityIndicator, StatusBar, TouchableOpacity,
            StyleSheet, Modal, Platform, TextInput, RefreshControl,
            KeyboardAvoidingView, Animated, Dimensions, Appearance, ScrollView, Alert
          } from 'react-native';
          import { Ionicons } from '@expo/vector-icons';
          import { SafeAreaProvider, useSafeAreaInsets } from 'react-native-safe-area-context';
          import AsyncStorage from '@react-native-async-storage/async-storage';
          import * as Notifications from 'expo-notifications';
          import * as Device from 'expo-device';
          import Constants from 'expo-constants';
          import Svg, { Polyline } from 'react-native-svg';

          // =======================
          //  AYARLAR (DEÄžÄ°ÅžTÄ°R)
          // =======================
          const DATA_URL = "https://creatorapp24.com/pre.php";

          // Push alarm sunucun varsa buraya yaz (yoksa boÅŸ bÄ±rak; local alarm yine Ã§alÄ±ÅŸÄ±r)
          // Ã–RNEK: "https://seninsite.com/push"
          const PUSH_SERVER_URL = ""; // opsiyonel

          // Veri yenileme
          const AUTO_REFRESH_MS = 15000;
          const FETCH_TIMEOUT_MS = 12000;

          // Local alarm tekrar bildirimi engelleme (aynÄ± alarm 5 dk iÃ§inde tekrar Ã§almasÄ±n)
          const ALARM_COOLDOWN_MS = 5 * 60 * 1000;

          const SCREEN_WIDTH = Dimensions.get('window').width;
          const DRAWER_WIDTH = SCREEN_WIDTH * 0.75;

          const STORAGE_KEYS = {
            favorites: 'ap_favorites_v1',
            alarms: 'ap_alarms_v1',
            settings: 'ap_settings_v1'
          };

          const LANG = {
            tr: {
              tab_currency: "DÃ–VÄ°Z",
              tab_gold: "ALTIN",
              tab_fav: "FAV",
              buy: "AlÄ±ÅŸ",
              sell: "SatÄ±ÅŸ",
              calcTitle: "HesaplayÄ±cÄ±",
              amount: "Miktar Giriniz",
              result: "SONUÃ‡",
              settings: "Ayarlar",
              theme: "Tema",
              language: "Dil",
              auto: "Otomatik",
              dark: "KaranlÄ±k",
              light: "AydÄ±nlÄ±k",
              adSpace: "REKLAM ALANI",
              bannerPlace: "REKLAM YERÄ°",
              favorites: "Favoriler",
              onlyFavs: "Sadece favoriler",
              alarms: "Alarmlar",
              addAlarm: "Alarm Ekle",
              alarmAbove: "ÃœstÃ¼ne Ã§Ä±kÄ±nca",
              alarmBelow: "AltÄ±na dÃ¼ÅŸÃ¼nce",
              targetPrice: "Hedef fiyat",
              save: "Kaydet",
              cancel: "Ä°ptal",
              proMode: "Pro Mod",
              proDesc: "Reklam kapalÄ±",
              pushStatus: "Push Durumu",
              pushOff: "KapalÄ± (server yok)",
              pushOn: "Aktif (server var)",
              notiPerm: "Bildirim izni",
              notiDenied: "KapalÄ±",
              notiGranted: "AÃ§Ä±k",
              updatedAt: "GÃ¼ncelleme",
              history: "Grafik",
              noHistory: "Grafik yok",
              errorFetch: "Veri alÄ±namadÄ±",
              errorJson: "JSON okunamadÄ±",
              ok: "Tamam"
            },
            en: {
              tab_currency: "CURRENCY",
              tab_gold: "GOLD",
              tab_fav: "FAV",
              buy: "Buy",
              sell: "Sell",
              calcTitle: "Calculator",
              amount: "Enter Amount",
              result: "RESULT",
              settings: "Settings",
              theme: "Theme",
              language: "Language",
              auto: "Auto",
              dark: "Dark",
              light: "Light",
              adSpace: "AD SPACE",
              bannerPlace: "AD PLACE",
              favorites: "Favorites",
              onlyFavs: "Only favorites",
              alarms: "Alarms",
              addAlarm: "Add Alarm",
              alarmAbove: "Notify if above",
              alarmBelow: "Notify if below",
              targetPrice: "Target price",
              save: "Save",
              cancel: "Cancel",
              proMode: "Pro Mode",
              proDesc: "Ads disabled",
              pushStatus: "Push Status",
              pushOff: "Off (no server)",
              pushOn: "On (server set)",
              notiPerm: "Notification permission",
              notiDenied: "Denied",
              notiGranted: "Granted",
              updatedAt: "Updated",
              history: "Chart",
              noHistory: "No chart",
              errorFetch: "Failed to fetch",
              errorJson: "Invalid JSON",
              ok: "OK"
            }
          };

          // Bildirim handler (iOS/Android)
          Notifications.setNotificationHandler({
            handleNotification: async () => ({
              shouldShowAlert: true,
              shouldPlaySound: true,
              shouldSetBadge: false
            })
          });

          function nowMs() { return Date.now(); }

          function safeJsonParse(x) {
            try { return JSON.parse(x); } catch { return null; }
          }

          function formatUpdatedAt(input) {
            if (!input) return '';
            try {
              const d = new Date(input);
              if (isNaN(d.getTime())) return String(input);
              return d.toLocaleString();
            } catch {
              return String(input);
            }
          }

          // Fiyat parse: "$4.887,42", "4.887,42 â‚º", "4887.42", "4,887.42" gibi durumlarÄ± dayanÄ±klÄ± ele alÄ±r
          function parsePrice(str) {
            if (str === null || str === undefined) return NaN;
            let s = String(str).trim();

            // para birimi / semboller
            s = s.replace(/[â‚º$â‚¬Â£]/g, '').replace(/TL/gi, '').replace(/\s+/g, '').trim();

            if (!s) return NaN;

            const hasComma = s.includes(',');
            const hasDot = s.includes('.');

            // TR: "4.887,42" -> 4887.42
            if (hasComma && hasDot) {
              // Son ayraÃ§ virgÃ¼lse: binlik "." kaldÄ±r, "," -> "."
              if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
                s = s.replace(/\./g, '').replace(',', '.');
              } else {
                // "4,887.42" gibi: binlik "," kaldÄ±r
                s = s.replace(/,/g, '');
              }
            } else if (hasComma && !hasDot) {
              // "123,45" -> 123.45
              s = s.replace(',', '.');
            } else {
              // sadece nokta veya hiÃ§ ayraÃ§ yok: olduÄŸu gibi
              s = s;
            }

            const v = parseFloat(s);
            return isNaN(v) ? NaN : v;
          }

          // Sparkline noktalarÄ±
          function buildSparkPoints(arr, w, h) {
            if (!Array.isArray(arr) || arr.length < 2) return null;
            const values = arr.map(p => Number(p?.v)).filter(v => Number.isFinite(v));
            if (values.length < 2) return null;

            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = (max - min) || 1;

            const stepX = w / (values.length - 1);
            const pts = values.map((v, i) => {
              const x = i * stepX;
              const y = h - ((v - min) / range) * h;
              return `${x.toFixed(2)},${y.toFixed(2)}`;
            });
            return pts.join(' ');
          }

          async function storageGet(key, fallback) {
            try {
              const v = await AsyncStorage.getItem(key);
              if (!v) return fallback;
              const j = safeJsonParse(v);
              return (j === null ? fallback : j);
            } catch {
              return fallback;
            }
          }

          async function storageSet(key, val) {
            try { await AsyncStorage.setItem(key, JSON.stringify(val)); } catch {}
          }

          // =======================
          //  MAIN APP
          // =======================
          function MainApp() {
            const insets = useSafeAreaInsets();
            const colorScheme = Appearance.getColorScheme();

            const [currencies, setCurrencies] = useState([]);
            const [golds, setGolds] = useState([]);
            const [historyMap, setHistoryMap] = useState({});
            const [updatedAt, setUpdatedAt] = useState('');

            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [activeTab, setActiveTab] = useState('currency'); // currency | gold | fav

            const [themeMode, setThemeMode] = useState('auto');
            const [language, setLanguage] = useState('tr');
            const [menuOpen, setMenuOpen] = useState(false);
            const [proMode, setProMode] = useState(false);

            const [favorites, setFavorites] = useState({}); // { kod: true }
            const [onlyFavs, setOnlyFavs] = useState(false);

            const [alarms, setAlarms] = useState([]); // [{id, code, type, target, enabled, lastTriggered}]
            const [pushToken, setPushToken] = useState('');
            const [notiGranted, setNotiGranted] = useState(false);

            // Modals
            const [detailVisible, setDetailVisible] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);

            const [calcAmount, setCalcAmount] = useState('');
            const [calcResult, setCalcResult] = useState(null);

            const [alarmModalVisible, setAlarmModalVisible] = useState(false);
            const [alarmType, setAlarmType] = useState('above'); // above | below
            const [alarmTarget, setAlarmTarget] = useState('');

            const slideAnim = useRef(new Animated.Value(-DRAWER_WIDTH)).current;
            const fadeAnim = useRef(new Animated.Value(0)).current;

            const isDarkMode = themeMode === 'auto' ? colorScheme === 'dark' : themeMode === 'dark';
            const T = LANG[language] || LANG.tr;

            const theme = useMemo(() => (
              isDarkMode ? {
                bg: '#000000', surface: '#1C1C1E', card: '#1C1C1E',
                text: '#FFFFFF', subText: '#8E8E93', gold: '#FFD60A',
                green: '#30D158', red: '#FF453A', border: '#38383A',
                modal: '#2C2C2E', input: '#2C2C2E', tint: 'rgba(255,255,255,0.1)',
                tabActive: '#3A3A3C'
              } : {
                bg: '#F2F2F7', surface: '#FFFFFF', card: '#FFFFFF',
                text: '#000000', subText: '#8E8E93', gold: '#FF9500',
                green: '#34C759', red: '#FF3B30', border: '#E5E5EA',
                modal: '#FFFFFF', input: '#F2F2F7', tint: 'rgba(0,0,0,0.05)',
                tabActive: '#E5E5EA'
              }
            ), [isDarkMode]);

            // Drawer anim
            useEffect(() => {
              Animated.parallel([
                Animated.timing(slideAnim, {
                  toValue: menuOpen ? 0 : -DRAWER_WIDTH,
                  duration: 260,
                  useNativeDriver: true
                }),
                Animated.timing(fadeAnim, {
                  toValue: menuOpen ? 1 : 0,
                  duration: 260,
                  useNativeDriver: true
                })
              ]).start();
            }, [menuOpen]);

            // Load persisted settings
            useEffect(() => {
              (async () => {
                const fav = await storageGet(STORAGE_KEYS.favorites, {});
                const alm = await storageGet(STORAGE_KEYS.alarms, []);
                const set = await storageGet(STORAGE_KEYS.settings, {
                  themeMode: 'auto',
                  language: 'tr',
                  proMode: false,
                  onlyFavs: false
                });

                setFavorites(fav || {});
                setAlarms(Array.isArray(alm) ? alm : []);
                setThemeMode(set?.themeMode || 'auto');
                setLanguage(set?.language || 'tr');
                setProMode(!!set?.proMode);
                setOnlyFavs(!!set?.onlyFavs);
              })();
            }, []);

            // Persist settings
            useEffect(() => {
              storageSet(STORAGE_KEYS.favorites, favorites);
            }, [favorites]);

            useEffect(() => {
              storageSet(STORAGE_KEYS.alarms, alarms);
              // push server varsa alarm sync dene
              if (PUSH_SERVER_URL && pushToken) syncAlarmsToServer(alarms).catch(() => {});
            }, [alarms]);

            useEffect(() => {
              storageSet(STORAGE_KEYS.settings, { themeMode, language, proMode, onlyFavs });
            }, [themeMode, language, proMode, onlyFavs]);

            // Notifications permission + token
            useEffect(() => {
              (async () => {
                try {
                  const granted = await ensureNotificationPermission();
                  setNotiGranted(granted);

                  if (granted) {
                    const token = await getExpoPushTokenSafe();
                    if (token) {
                      setPushToken(token);
                      if (PUSH_SERVER_URL) {
                        await registerDeviceToServer(token);
                        await syncAlarmsToServer(await storageGet(STORAGE_KEYS.alarms, []));
                      }
                    }
                  }
                } catch {
                  // sessiz
                }
              })();
            }, []);

            async function ensureNotificationPermission() {
              try {
                const settings = await Notifications.getPermissionsAsync();
                let status = settings?.status;

                if (status !== 'granted') {
                  const req = await Notifications.requestPermissionsAsync();
                  status = req?.status;
                }
                return status === 'granted';
              } catch {
                return false;
              }
            }

            async function getExpoPushTokenSafe() {
              try {
                // SimÃ¼latÃ¶rde token yok
                if (!Device.isDevice) return '';
                const projectId =
                  Constants?.expoConfig?.extra?.eas?.projectId ||
                  Constants?.easConfig?.projectId ||
                  '';
                if (!projectId) return '';

                const token = (await Notifications.getExpoPushTokenAsync({ projectId }))?.data;
                return token || '';
              } catch {
                return '';
              }
            }

            async function registerDeviceToServer(token) {
              if (!PUSH_SERVER_URL) return;
              try {
                const body = {
                  token,
                  platform: Platform.OS,
                  device: Device?.modelName || 'unknown',
                  appVersion: Constants?.expoConfig?.version || '0',
                  ts: Date.now()
                };
                await fetch(`${PUSH_SERVER_URL.replace(/\/$/, '')}/register`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(body)
                });
              } catch {
                // sessiz
              }
            }

            async function syncAlarmsToServer(list) {
              if (!PUSH_SERVER_URL || !pushToken) return;
              try {
                const body = { token: pushToken, alarms: list || [] };
                await fetch(`${PUSH_SERVER_URL.replace(/\/$/, '')}/alarms/sync`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(body)
                });
              } catch {
                // sessiz
              }
            }

            // Fetch with timeout + safe parse
            const loadData = async (isAuto = false) => {
              if (!isAuto) setLoading(true);
              try {
                const controller = new AbortController();
                const t = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

                const resp = await fetch(DATA_URL, {
                  headers: { 'Cache-Control': 'no-cache' },
                  signal: controller.signal
                });

                clearTimeout(t);

                const text = await resp.text();
                const json = safeJsonParse(text);
                if (!json) {
                  // JSON bozuk
                  // sadece console, UIâ€™yÄ± Ã§Ã¶kertme
                  console.error(T.errorJson);
                  return;
                }

                // meta.updated_at (opsiyonel)
                if (json.meta?.updated_at) setUpdatedAt(formatUpdatedAt(json.meta.updated_at));

                // history map (opsiyonel)
                if (json.history && typeof json.history === 'object') setHistoryMap(json.history);

                // { veriler: { doviz:[], altin:[] } }
                if (json.veriler) {
                  if (Array.isArray(json.veriler.doviz)) setCurrencies(json.veriler.doviz);
                  if (Array.isArray(json.veriler.altin)) setGolds(json.veriler.altin);
                } else {
                  // fallback: bilinmeyen yapÄ±
                  // kÄ±rma, sadece boÅŸ bÄ±rak
                }

                // alarm kontrol (local)
                runLocalAlarmChecks(json);

              } catch (e) {
                console.error(T.errorFetch, e?.message || e);
              } finally {
                setLoading(false);
                setRefreshing(false);
              }
            };

            function runLocalAlarmChecks(json) {
              try {
                if (!notiGranted) return;
                const list = Array.isArray(alarms) ? alarms : [];
                if (!list.length) return;

                const map = new Map();

                const addToMap = (arr) => {
                  if (!Array.isArray(arr)) return;
                  for (const it of arr) {
                    const code = (it?.kod || '').toString();
                    if (!code) continue;
                    const price = parsePrice(it?.satis);
                    if (!Number.isFinite(price)) continue;
                    map.set(code, { item: it, price });
                  }
                };

                if (json?.veriler) {
                  addToMap(json.veriler.doviz);
                  addToMap(json.veriler.altin);
                } else {
                  // stateâ€™den kontrol (fallback)
                  addToMap(currencies);
                  addToMap(golds);
                }

                const now = nowMs();
                let changed = false;

                const next = list.map(a => {
                  if (!a?.enabled) return a;
                  const code = a?.code;
                  const row = map.get(code);
                  if (!row) return a;

                  const target = Number(a?.target);
                  if (!Number.isFinite(target)) return a;

                  const last = Number(a?.lastTriggered || 0);
                  const canTrigger = (now - last) > ALARM_COOLDOWN_MS;

                  let hit = false;
                  if (a.type === 'above' && row.price >= target) hit = true;
                  if (a.type === 'below' && row.price <= target) hit = true;

                  if (hit && canTrigger) {
                    changed = true;
                    fireLocalNotification(code, row.price, a.type, target);
                    return { ...a, lastTriggered: now };
                  }
                  return a;
                });

                if (changed) setAlarms(next);

              } catch {
                // sessiz
              }
            }

            async function fireLocalNotification(code, price, type, target) {
              try {
                const up = type === 'above';
                const title = `Alarm: ${code}`;
                const body = up
                  ? `${code} hedefin Ã¼stÃ¼nde: ${price} (hedef ${target})`
                  : `${code} hedefin altÄ±nda: ${price} (hedef ${target})`;

                await Notifications.scheduleNotificationAsync({
                  content: { title, body },
                  trigger: null
                });
              } catch {
                // sessiz
              }
            }

            useEffect(() => {
              loadData();
              const i = setInterval(() => loadData(true), AUTO_REFRESH_MS);
              return () => clearInterval(i);
              // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [notiGranted]); // izin deÄŸiÅŸirse kontrol mantÄ±ÄŸÄ± tekrar dÃ¼zgÃ¼n Ã§alÄ±ÅŸsÄ±n

            const onRefresh = () => {
              setRefreshing(true);
              loadData(true);
            };

            const getStatusData = (yon) => {
              const y = (yon || '').toString().toLowerCase();
              if (y.includes('yuksel') || y.includes('up')) return { color: theme.green, icon: 'caret-up' };
              if (y.includes('dusus') || y.includes('down')) return { color: theme.red, icon: 'caret-down' };
              return { color: theme.subText, icon: 'remove-outline' };
            };

            const isFavorite = (code) => !!favorites?.[code];

            const toggleFavorite = (code) => {
              if (!code) return;
              setFavorites(prev => {
                const p = { ...(prev || {}) };
                if (p[code]) delete p[code];
                else p[code] = true;
                return p;
              });
            };

            // Tab data
            const baseData = useMemo(() => {
              if (activeTab === 'currency') return currencies;
              if (activeTab === 'gold') return golds;

              // fav tab: hem dÃ¶viz hem altÄ±n, favorilere gÃ¶re
              const all = [...(currencies || []), ...(golds || [])];
              return all.filter(it => isFavorite(it?.kod));
            }, [activeTab, currencies, golds, favorites]);

            const listData = useMemo(() => {
              if (!onlyFavs || activeTab === 'fav') return baseData;
              return (baseData || []).filter(it => isFavorite(it?.kod));
            }, [baseData, onlyFavs, activeTab, favorites]);

            const openDetail = (item) => {
              setSelectedItem(item);
              setCalcAmount('');
              setCalcResult(null);
              setDetailVisible(true);
            };

            const handleCalculate = (text) => {
              setCalcAmount(text);
              try {
                const val = parsePrice(text);
                const price = parsePrice(selectedItem?.satis);
                if (Number.isFinite(val) && Number.isFinite(price)) {
                  setCalcResult((val * price).toFixed(2));
                } else {
                  setCalcResult(null);
                }
              } catch {
                setCalcResult(null);
              }
            };

            const itemAlarms = useMemo(() => {
              const code = selectedItem?.kod;
              if (!code) return [];
              return (alarms || []).filter(a => a?.code === code);
            }, [alarms, selectedItem]);

            const createAlarm = () => {
              const code = selectedItem?.kod;
              if (!code) return;

              const target = parsePrice(alarmTarget);
              if (!Number.isFinite(target) || target <= 0) {
                Alert.alert("Hata", T.targetPrice, [{ text: T.ok }]);
                return;
              }

              const id = `${code}_${alarmType}_${Date.now()}`;
              const obj = { id, code, type: alarmType, target, enabled: true, lastTriggered: 0 };
              setAlarms(prev => [obj, ...(prev || [])]);

              setAlarmModalVisible(false);
              setAlarmTarget('');
              setAlarmType('above');
            };

            const toggleAlarmEnabled = (id) => {
              setAlarms(prev => (prev || []).map(a => a.id === id ? { ...a, enabled: !a.enabled } : a));
            };

            const deleteAlarm = (id) => {
              setAlarms(prev => (prev || []).filter(a => a.id !== id));
            };

            const pushStatusText = PUSH_SERVER_URL ? T.pushOn : T.pushOff;
            const notiText = notiGranted ? T.notiGranted : T.notiDenied;

            const renderItem = ({ item }) => {
              const status = getStatusData(item?.yon);
              const code = (item?.kod || '').toString();
              const displayName = (item?.isim && item.isim.trim() !== "") ? item.isim : code;
              const fav = isFavorite(code);

              const hist = historyMap?.[code];
              const spark = buildSparkPoints(hist, 90, 30);

              return (
                <TouchableOpacity onPress={() => openDetail(item)} activeOpacity={0.75}>
                  <View style={[styles.card, { backgroundColor: theme.card }]}>
                    <View style={{flexDirection:'row', alignItems:'center', flex:1}}>
                      <View style={[styles.iconBox, { backgroundColor: theme.tint }]}>
                        <Text style={{fontSize:16, fontWeight:'800', color: theme.gold}}>
                          {code ? code.substring(0,1) : '$'}
                        </Text>
                      </View>

                      <View style={{marginLeft: 12, flex:1}}>
                        <Text style={{color: theme.text, fontWeight:'800', fontSize:16}} numberOfLines={1}>{code}</Text>
                        <Text style={{color: theme.subText, fontSize:11, marginTop:2}} numberOfLines={1}>
                          {displayName}
                        </Text>

                        {spark ? (
                          <View style={{ marginTop: 6, width: 90, height: 30, opacity: 0.9 }}>
                            <Svg width={90} height={30}>
                              <Polyline
                                points={spark}
                                fill="none"
                                stroke={status.color}
                                strokeWidth="2"
                                strokeLinejoin="round"
                                strokeLinecap="round"
                              />
                            </Svg>
                          </View>
                        ) : (
                          <View style={{ marginTop: 6, width: 90, height: 30, justifyContent:'center' }}>
                            <Text style={{color: theme.subText, fontSize:10}}>{T.noHistory}</Text>
                          </View>
                        )}
                      </View>
                    </View>

                    <View style={{alignItems:'flex-end', marginLeft: 10}}>
                      <TouchableOpacity onPress={() => toggleFavorite(code)} style={{padding:6}} hitSlop={{top:10,bottom:10,left:10,right:10}}>
                        <Ionicons name={fav ? "star" : "star-outline"} size={20} color={fav ? theme.gold : theme.subText} />
                      </TouchableOpacity>

                      <View style={{flexDirection:'row', alignItems:'center'}}>
                        <Text style={{color: theme.text, fontSize:17, fontWeight:'900', marginRight:4, fontVariant: ['tabular-nums']}}>
                          {item?.satis}
                        </Text>
                        <Ionicons name={status.icon} size={16} color={status.color} />
                      </View>

                      <View style={{flexDirection:'row', marginTop:4, alignItems:'center'}}>
                        <Text style={{color: status.color, fontSize:11, fontWeight:'700', marginRight: 8}}>
                          {item?.degisim}
                        </Text>
                        <Text style={{color: theme.subText, fontSize:11}}>
                          {T.buy}: {item?.alis}
                        </Text>
                      </View>
                    </View>
                  </View>
                </TouchableOpacity>
              );
            };

            const Header = () => (
              <View style={[styles.header, { paddingTop: insets.top + 10, backgroundColor: theme.surface, borderBottomColor: theme.border }]}>
                <TouchableOpacity onPress={() => setMenuOpen(true)} style={styles.headerBtn}>
                  <Ionicons name="menu" size={28} color={theme.gold} />
                </TouchableOpacity>

                <View style={{alignItems:'center'}}>
                  <Text style={[styles.title, { color: theme.text }]}>
                    ANLIK <Text style={{color: theme.gold}}>PÄ°YASA</Text>
                  </Text>
                  {!!updatedAt && (
                    <Text style={{color: theme.subText, fontSize:10, marginTop:2}}>
                      {T.updatedAt}: {updatedAt}
                    </Text>
                  )}
                </View>

                <TouchableOpacity onPress={() => setOnlyFavs(v => !v)} style={styles.headerBtn}>
                  <Ionicons name={onlyFavs ? "star" : "star-outline"} size={24} color={onlyFavs ? theme.gold : theme.subText} />
                </TouchableOpacity>
              </View>
            );

            const Tabs = () => (
              <View style={[styles.tabContainer, { backgroundColor: theme.surface }]}>
                <TouchableOpacity
                  onPress={() => setActiveTab('currency')}
                  style={[styles.tabBtn, activeTab === 'currency' && { backgroundColor: theme.tabActive }]}
                >
                  <Text style={[styles.tabText, { color: activeTab === 'currency' ? theme.gold : theme.subText }]}>{T.tab_currency}</Text>
                </TouchableOpacity>

                <TouchableOpacity
                  onPress={() => setActiveTab('gold')}
                  style={[styles.tabBtn, activeTab === 'gold' && { backgroundColor: theme.tabActive }]}
                >
                  <Text style={[styles.tabText, { color: activeTab === 'gold' ? theme.gold : theme.subText }]}>{T.tab_gold}</Text>
                </TouchableOpacity>

                <TouchableOpacity
                  onPress={() => setActiveTab('fav')}
                  style={[styles.tabBtn, activeTab === 'fav' && { backgroundColor: theme.tabActive }]}
                >
                  <Text style={[styles.tabText, { color: activeTab === 'fav' ? theme.gold : theme.subText }]}>{T.tab_fav}</Text>
                </TouchableOpacity>
              </View>
            );

            return (
              <View style={[styles.container, { backgroundColor: theme.bg }]}>
                <StatusBar barStyle={isDarkMode ? "light-content" : "dark-content"} />

                <Header />
                <Tabs />

                {loading ? (
                  <ActivityIndicator size="large" color={theme.gold} style={{marginTop:50}} />
                ) : (
                  <FlatList
                    data={listData}
                    keyExtractor={(item, index) => `${item?.kod || 'x'}_${index}`}
                    renderItem={renderItem}
                    refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={theme.gold} />}
                    contentContainerStyle={{paddingTop: 14, paddingBottom: proMode ? 24 : 100}}
                    ItemSeparatorComponent={() => <View style={{height: 10}} />}
                    ListEmptyComponent={
                      <Text style={{color:theme.subText, textAlign:'center', marginTop:20}}>
                        {T.favorites}: {Object.keys(favorites || {}).length} / {T.onlyFavs}: {onlyFavs ? 'ON' : 'OFF'}
                      </Text>
                    }
                  />
                )}

                {!proMode && (
                  <View style={[styles.bannerContainer, { paddingBottom: insets.bottom + 10, backgroundColor: theme.surface, borderTopColor: theme.border }]}>
                    <Text style={{color: theme.subText, fontSize:9, marginBottom:4, letterSpacing:1}}>{T.adSpace}</Text>
                    <View style={[styles.bannerBox, { backgroundColor: theme.tint, borderColor: theme.border }]}>
                      <Text style={{color: theme.gold, fontWeight:'700', fontSize:12, textAlign:'center'}}>{T.bannerPlace}</Text>
                    </View>
                  </View>
                )}

                {menuOpen && (
                  <Animated.View style={[styles.menuOverlay, { opacity: fadeAnim }]}>
                    <TouchableOpacity style={{flex:1}} onPress={() => setMenuOpen(false)} activeOpacity={1} />
                  </Animated.View>
                )}

                <Animated.View
                  style={[
                    styles.drawer,
                    {
                      width: DRAWER_WIDTH,
                      backgroundColor: theme.surface,
                      transform: [{ translateX: slideAnim }],
                      paddingTop: insets.top + 18
                    }
                  ]}
                >
                  <View style={{paddingHorizontal: 20, marginBottom: 18}}>
                    <Text style={{fontSize: 28, fontWeight: '900', color: theme.text}}>{T.settings}</Text>
                    <Text style={{fontSize: 13, color: theme.subText, marginTop: 6}}>
                      v1.1.0 â€¢ {T.pushStatus}: {pushStatusText} â€¢ {T.notiPerm}: {notiText}
                    </Text>
                    {!!pushToken && (
                      <Text style={{fontSize: 10, color: theme.subText, marginTop: 6}} numberOfLines={1}>
                        token: {pushToken}
                      </Text>
                    )}
                  </View>

                  <ScrollView style={{flex:1}}>
                    <View style={styles.menuSection}>
                      <Text style={[styles.menuHeader, {color: theme.subText}]}>{T.proMode.toUpperCase()}</Text>
                      <TouchableOpacity
                        onPress={() => setProMode(v => !v)}
                        style={[styles.menuItem, {borderBottomColor: theme.border}]}
                      >
                        <Text style={{color: theme.text, fontSize:16, fontWeight:'700'}}>{T.proMode}</Text>
                        <View style={{flexDirection:'row', alignItems:'center', gap: 8}}>
                          <Text style={{color: theme.subText, fontSize:12}}>{proMode ? T.proDesc : ''}</Text>
                          <Ionicons name={proMode ? "checkmark-circle" : "ellipse-outline"} size={22} color={proMode ? theme.gold : theme.subText} />
                        </View>
                      </TouchableOpacity>
                    </View>

                    <View style={styles.menuSection}>
                      <Text style={[styles.menuHeader, {color: theme.subText}]}>{T.theme.toUpperCase()}</Text>
                      {['auto', 'light', 'dark'].map((m) => (
                        <TouchableOpacity key={m} onPress={() => setThemeMode(m)} style={[styles.menuItem, {borderBottomColor: theme.border}]}>
                          <Text style={{color: theme.text, fontSize:16, textTransform:'capitalize'}}>{T[m]}</Text>
                          {themeMode === m && <Ionicons name="checkmark" size={22} color={theme.gold} />}
                        </TouchableOpacity>
                      ))}
                    </View>

                    <View style={styles.menuSection}>
                      <Text style={[styles.menuHeader, {color: theme.subText}]}>{T.language.toUpperCase()}</Text>
                      {['tr', 'en'].map((l) => (
                        <TouchableOpacity key={l} onPress={() => setLanguage(l)} style={[styles.menuItem, {borderBottomColor: theme.border}]}>
                          <Text style={{color: theme.text, fontSize:16}}>{l === 'tr' ? 'TÃ¼rkÃ§e' : 'English'}</Text>
                          {language === l && <Ionicons name="checkmark" size={22} color={theme.gold} />}
                        </TouchableOpacity>
                      ))}
                    </View>

                    <View style={styles.menuSection}>
                      <Text style={[styles.menuHeader, {color: theme.subText}]}>{T.favorites.toUpperCase()}</Text>
                      <TouchableOpacity
                        onPress={() => setOnlyFavs(v => !v)}
                        style={[styles.menuItem, {borderBottomColor: theme.border}]}
                      >
                        <Text style={{color: theme.text, fontSize:16}}>{T.onlyFavs}</Text>
                        <Ionicons name={onlyFavs ? "checkmark" : "remove-outline"} size={22} color={onlyFavs ? theme.gold : theme.subText} />
                      </TouchableOpacity>
                    </View>
                  </ScrollView>
                </Animated.View>

                {/* DETAIL MODAL: Hesap + Favori + Alarm */}
                <Modal visible={detailVisible} transparent animationType="slide" onRequestClose={() => setDetailVisible(false)}>
                  <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={styles.modalOverlay}>
                    <TouchableOpacity style={{flex:1, justifyContent:'flex-end'}} activeOpacity={1} onPress={() => setDetailVisible(false)}>
                      <TouchableOpacity activeOpacity={1} style={[styles.detailContent, { backgroundColor: theme.modal, paddingBottom: insets.bottom + 20 }]}>
                        <View style={styles.dragHandle} />

                        <View style={{flexDirection:'row', justifyContent:'space-between', alignItems:'center', marginBottom:16}}>
                          <View>
                            <Text style={{color:theme.text, fontSize:20, fontWeight:'900'}}>
                              {selectedItem?.kod || '-'}
                            </Text>
                            <Text style={{color:theme.subText, fontSize:12, marginTop:2}} numberOfLines={1}>
                              {(selectedItem?.isim && selectedItem.isim.trim() !== "") ? selectedItem.isim : (selectedItem?.kod || '')}
                            </Text>
                          </View>

                          <View style={{flexDirection:'row', alignItems:'center', gap: 10}}>
                            <TouchableOpacity onPress={() => toggleFavorite(selectedItem?.kod)} style={{padding:8, backgroundColor: theme.tint, borderRadius:18}}>
                              <Ionicons name={isFavorite(selectedItem?.kod) ? "star" : "star-outline"} size={18} color={theme.gold} />
                            </TouchableOpacity>
                            <TouchableOpacity onPress={() => setDetailVisible(false)} style={{padding:8, backgroundColor: theme.tint, borderRadius:18}}>
                              <Ionicons name="close" size={18} color={theme.subText} />
                            </TouchableOpacity>
                          </View>
                        </View>

                        <View style={{alignItems:'center', marginBottom: 16}}>
                          <Text style={{color: theme.gold, fontSize:34, fontWeight:'900'}}>
                            {selectedItem?.satis || '-'}
                          </Text>
                          <Text style={{color: theme.subText, fontSize:12, marginTop: 4}}>
                            {T.buy}: {selectedItem?.alis || '-'}   â€¢   {selectedItem?.degisim || '-'}
                          </Text>
                        </View>

                        {/* Calculator */}
                        <Text style={{color:theme.text, fontSize:16, fontWeight:'800', marginBottom: 10}}>{T.calcTitle}</Text>
                        <TextInput
                          style={[styles.input, { backgroundColor: theme.input, color: theme.text }]}
                          placeholder={T.amount}
                          placeholderTextColor={theme.subText}
                          keyboardType="numeric"
                          value={calcAmount}
                          onChangeText={handleCalculate}
                        />
                        {calcResult && (
                          <View style={{marginTop:14, padding:14, backgroundColor: theme.green, borderRadius:16, alignItems:'center'}}>
                            <Text style={{color:'#FFF', fontSize:26, fontWeight:'900'}}>{calcResult} â‚º</Text>
                          </View>
                        )}

                        {/* Alarms */}
                        <View style={{marginTop:18}}>
                          <View style={{flexDirection:'row', justifyContent:'space-between', alignItems:'center'}}>
                            <Text style={{color:theme.text, fontSize:16, fontWeight:'900'}}>{T.alarms}</Text>
                            <TouchableOpacity
                              onPress={() => {
                                if (!notiGranted) {
                                  Alert.alert("Bildirim", "Bildirim izni kapalÄ±. iOS Ayarlar'dan aÃ§malÄ±sÄ±n.", [{ text: T.ok }]);
                                  return;
                                }
                                setAlarmModalVisible(true);
                              }}
                              style={{paddingHorizontal:12, paddingVertical:8, backgroundColor: theme.tint, borderRadius:12}}
                            >
                              <Text style={{color: theme.gold, fontWeight:'800'}}>{T.addAlarm}</Text>
                            </TouchableOpacity>
                          </View>

                          {itemAlarms.length === 0 ? (
                            <Text style={{color: theme.subText, fontSize:12, marginTop: 10}}>
                              {PUSH_SERVER_URL ? "Push server varsa kapalÄ±yken de Ã§alÄ±ÅŸÄ±r." : "Åžu an local alarm (uygulama aÃ§Ä±kken) Ã§alÄ±ÅŸÄ±r."}
                            </Text>
                          ) : (
                            <View style={{marginTop: 10}}>
                              {itemAlarms.map(a => (
                                <View key={a.id} style={[styles.alarmRow, { borderColor: theme.border, backgroundColor: theme.tint }]}>
                                  <View style={{flex:1}}>
                                    <Text style={{color: theme.text, fontWeight:'900'}}>
                                      {a.type === 'above' ? T.alarmAbove : T.alarmBelow} â€¢ {a.target}
                                    </Text>
                                    <Text style={{color: theme.subText, fontSize:11, marginTop: 2}}>
                                      {a.enabled ? "ON" : "OFF"} {a.lastTriggered ? `â€¢ last: ${new Date(a.lastTriggered).toLocaleTimeString()}` : ""}
                                    </Text>
                                  </View>

                                  <TouchableOpacity onPress={() => toggleAlarmEnabled(a.id)} style={{padding:8}}>
                                    <Ionicons name={a.enabled ? "notifications" : "notifications-off"} size={20} color={a.enabled ? theme.gold : theme.subText} />
                                  </TouchableOpacity>

                                  <TouchableOpacity onPress={() => deleteAlarm(a.id)} style={{padding:8}}>
                                    <Ionicons name="trash-outline" size={20} color={theme.red} />
                                  </TouchableOpacity>
                                </View>
                              ))}
                            </View>
                          )}
                        </View>

                        {/* Alarm Add Modal */}
                        <Modal visible={alarmModalVisible} transparent animationType="fade" onRequestClose={() => setAlarmModalVisible(false)}>
                          <View style={[styles.centerOverlay, { backgroundColor: 'rgba(0,0,0,0.6)' }]}>
                            <View style={[styles.alarmBox, { backgroundColor: theme.modal, borderColor: theme.border }]}>
                              <Text style={{color: theme.text, fontSize:16, fontWeight:'900', marginBottom: 12}}>
                                {T.addAlarm} â€¢ {selectedItem?.kod}
                              </Text>

                              <View style={{flexDirection:'row', gap: 10}}>
                                <TouchableOpacity
                                  onPress={() => setAlarmType('above')}
                                  style={[styles.chip, { backgroundColor: alarmType === 'above' ? theme.tabActive : theme.tint, borderColor: theme.border }]}
                                >
                                  <Text style={{color: alarmType === 'above' ? theme.gold : theme.text, fontWeight:'800'}}>{T.alarmAbove}</Text>
                                </TouchableOpacity>

                                <TouchableOpacity
                                  onPress={() => setAlarmType('below')}
                                  style={[styles.chip, { backgroundColor: alarmType === 'below' ? theme.tabActive : theme.tint, borderColor: theme.border }]}
                                >
                                  <Text style={{color: alarmType === 'below' ? theme.gold : theme.text, fontWeight:'800'}}>{T.alarmBelow}</Text>
                                </TouchableOpacity>
                              </View>

                              <TextInput
                                style={[styles.input, { backgroundColor: theme.input, color: theme.text, marginTop: 12 }]}
                                placeholder={T.targetPrice}
                                placeholderTextColor={theme.subText}
                                keyboardType="numeric"
                                value={alarmTarget}
                                onChangeText={setAlarmTarget}
                              />

                              <View style={{flexDirection:'row', justifyContent:'flex-end', gap: 10, marginTop: 14}}>
                                <TouchableOpacity onPress={() => setAlarmModalVisible(false)} style={[styles.btn, { backgroundColor: theme.tint }]}>
                                  <Text style={{color: theme.text, fontWeight:'800'}}>{T.cancel}</Text>
                                </TouchableOpacity>
                                <TouchableOpacity onPress={createAlarm} style={[styles.btn, { backgroundColor: theme.gold }]}>
                                  <Text style={{color: '#000', fontWeight:'900'}}>{T.save}</Text>
                                </TouchableOpacity>
                              </View>

                              {!PUSH_SERVER_URL && (
                                <Text style={{color: theme.subText, fontSize:11, marginTop: 12}}>
                                  Not: Push server yok â†’ alarmlar uygulama aÃ§Ä±kken kontrol edilir.
                                </Text>
                              )}
                            </View>
                          </View>
                        </Modal>

                      </TouchableOpacity>
                    </TouchableOpacity>
                  </KeyboardAvoidingView>
                </Modal>

              </View>
            );
          }

          export default function App() {
            return (
              <SafeAreaProvider>
                <MainApp />
              </SafeAreaProvider>
            );
          }

          const styles = StyleSheet.create({
            container: { flex: 1 },

            header: {
              flexDirection: 'row',
              justifyContent: 'space-between',
              alignItems: 'center',
              paddingHorizontal: 16,
              paddingBottom: 12,
              borderBottomWidth: 0.5,
              zIndex: 1
            },
            headerBtn: { width: 42, height: 42, justifyContent:'center', alignItems:'center' },
            title: { fontSize: 20, fontWeight: '900', letterSpacing: 0.5 },

            tabContainer: { flexDirection: 'row', padding: 10, gap: 10 },
            tabBtn: { flex: 1, paddingVertical: 10, alignItems: 'center', borderRadius: 10, borderWidth: 1, borderColor: 'transparent' },
            tabText: { fontWeight: '900', fontSize: 13 },

            card: {
              flexDirection: 'row',
              justifyContent: 'space-between',
              padding: 16,
              marginHorizontal: 16,
              borderRadius: 18,
              shadowOpacity: 0.05,
              shadowRadius: 6,
              shadowOffset: {width:0, height:2},
              elevation: 2
            },
            iconBox: { width: 44, height: 44, borderRadius: 22, justifyContent:'center', alignItems:'center' },

            bannerContainer: { alignItems:'center', borderTopWidth:0.5, padding: 10 },
            bannerBox: { width: 320, height: 50, borderWidth:1, borderStyle:'dashed', justifyContent:'center', alignItems:'center', borderRadius:12 },

            menuOverlay: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 10 },
            drawer: {
              position: 'absolute', top: 0, bottom: 0, left: 0, zIndex: 11,
              shadowColor: "#000", shadowOffset: { width: 5, height: 0 }, shadowOpacity: 0.2, shadowRadius: 10, elevation: 20
            },
            menuSection: { marginTop: 18, paddingHorizontal: 20 },
            menuHeader: { fontSize: 12, fontWeight: '900', marginBottom: 8, letterSpacing: 1 },
            menuItem: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', paddingVertical: 14, borderBottomWidth: 0.5 },

            modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.6)', justifyContent: 'flex-end' },
            detailContent: { width: '100%', padding: 22, borderTopLeftRadius: 28, borderTopRightRadius: 28 },

            dragHandle: { width: 44, height: 5, backgroundColor: '#CCC', borderRadius: 3, alignSelf: 'center', marginBottom: 14, opacity: 0.35 },
            input: { height: 56, borderRadius: 16, paddingHorizontal: 18, fontSize: 20, fontWeight:'700' },

            alarmRow: {
              flexDirection:'row',
              alignItems:'center',
              padding: 12,
              borderWidth: 1,
              borderRadius: 14,
              marginBottom: 10
            },

            centerOverlay: { flex: 1, justifyContent:'center', alignItems:'center', padding: 20 },
            alarmBox: { width: '100%', borderWidth: 1, borderRadius: 18, padding: 16 },

            chip: { flex: 1, paddingVertical: 10, paddingHorizontal: 12, borderRadius: 14, borderWidth: 1, alignItems:'center' },
            btn: { paddingVertical: 10, paddingHorizontal: 16, borderRadius: 12 }
          });
          EOF

      # 6. APP.JSON (notifications plugin + runtime)
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "ANLIK PÄ°YASA",
              "slug": "anlikpiyasa",
              "version": "1.1.0",
              "orientation": "portrait",
              "userInterfaceStyle": "automatic",
              "icon": "./assets/icon.png",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#000000"
              },
              "plugins": [
                "expo-notifications"
              ],
              "notification": {
                "icon": "./assets/icon.png",
                "color": "#000000"
              },
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "supportsTablet": true,
                "infoPlist": {
                  "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true }
                }
              },
              "android": {
                "package": "com.piyasapro.app",
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#000000"
                }
              },
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": {
                "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" }
              }
            }
          }
          EOF

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      # (Opsiyonel) BUILD: workflow_dispatch -> do_build=true
      - name: ðŸ§± EAS Build (Opsiyonel)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.do_build == 'true' }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform ios --profile preview --non-interactive --no-wait || true

      # UPDATE (EAS Update)
      - name: ðŸš€ GÃ¼ncelle (Update)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "FINAL: Favorites + Alarms + PushInfra + Sparkline + ProMode + API Fix" --non-interactive
