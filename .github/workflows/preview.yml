name: ANLIK PÄ°YASA - FULL RESET (GUARANTEED OPEN)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-final-fix:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TAM TEMÄ°ZLÄ°K (Eski kalan her ÅŸeyi siler)
      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist credentials.json

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. GÃ–RSELLER
      - name: ðŸŽ¨ GÃ¶rselleri OluÅŸtur
        run: |
          sudo apt-get install imagemagick -y
          mkdir -p assets
          
          # Ä°kon
          curl -L -o assets/icon.png "https://i.ibb.co/99mj6zkx/71cf52be-22d6-4382-8a4e-bb42ea43796e.png"
          
          # Splash (Native iÃ§in de var ama JS ile de Ã§izeceÄŸiz)
          convert -size 1242x2688 xc:"#000000" \
            -fill "#F59E0B" -font DejaVu-Sans-Bold -gravity center -pointsize 100 -annotate 0 "ANLIK PÄ°YASA" \
            assets/splash.png
            
          cp assets/icon.png assets/adaptive-icon.png
          cp assets/icon.png assets/favicon.png

      # 3. PACKAGE.JSON (Splash kÃ¼tÃ¼phanesini sildim, JS ile yapacaÄŸÄ±z)
      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "fs-extra": "^11.2.0",
              "@expo/vector-icons": "~14.0.0",
              "react-native-safe-area-context": "4.12.0",
              "expo-localization": "~16.0.0",
              "i18n-js": "^4.4.3"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # 4. CONFIG DOSYALARI
      - name: âš™ï¸ Config DosyalarÄ±
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) { api.cache(true); return { presets: ['babel-preset-expo'] }; };
          EOF
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config'); const config = getDefaultConfig(__dirname); module.exports = config;
          EOF

      # 5. APP.JS (TAKILMA RÄ°SKÄ° OLMAYAN VERSÄ°YON)
      - name: ðŸ“± App.js OluÅŸtur
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect, useRef } from 'react';
          import { 
            Text, View, FlatList, ActivityIndicator, StatusBar, TouchableOpacity, 
            StyleSheet, Modal, Platform, TextInput, Keyboard, RefreshControl, 
            Animated, Dimensions
          } from 'react-native';
          import { Ionicons } from '@expo/vector-icons';
          import { SafeAreaProvider, useSafeAreaInsets } from 'react-native-safe-area-context';
          import * as Localization from 'expo-localization';

          // NOT: Native Splash kÃ¼tÃ¼phanesini kaldÄ±rdÄ±k. 
          // ArtÄ±k uygulama aÃ§Ä±lÄ±r aÃ§Ä±lmaz kendi "Fake Splash" ekranÄ±nÄ± gÃ¶sterecek.
          // Bu sayede native tarafta takÄ±lÄ± kalma riski yok.

          const BANNER_ID = "ca-app-pub-2289573527937577/9217874142";
          const URL = "https://imdatgel.site/harem/piyasa_cache.json";
          const SCREEN_WIDTH = Dimensions.get('window').width;

          const translations = {
            tr: { title: "ANLIK", titlePro: "PÄ°YASA", buy: "AlÄ±ÅŸ", calc: "Hesapla", calcTitle: "Hesap Makinesi", amount: "Miktar", result: "TOPLAM TUTAR", settings: "Ayarlar", language: "Dil SeÃ§eneÄŸi", theme: "Tema", auto: "Otomatik", adSpace: "REKLAM ALANI" },
            en: { title: "LIVE", titlePro: "MARKET", buy: "Buy", calc: "Calculate", calcTitle: "Calculator", amount: "Amount", result: "TOTAL PRICE", settings: "Settings", language: "Language", theme: "Theme", auto: "Automatic", adSpace: "AD SPACE" }
          };

          function MainApp() {
            const insets = useSafeAreaInsets();
            
            // --- SOFTWARE SPLASH STATE ---
            // Uygulama baÅŸlar baÅŸlamaz bu TRUE olur ve Siyah EkranÄ± gÃ¶sterir.
            const [showFakeSplash, setShowFakeSplash] = useState(true);

            const [data, setData] = useState([]);
            const [prevData, setPrevData] = useState({});
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [currentTime, setCurrentTime] = useState("");

            const [locale, setLocale] = useState(Localization.getLocales()[0].languageCode);
            const [userLang, setUserLang] = useState('auto');
            const t = translations[userLang === 'auto' ? (locale.includes('tr') ? 'tr' : 'en') : userLang];

            const [menuVisible, setMenuVisible] = useState(false);
            const slideAnim = useRef(new Animated.Value(-SCREEN_WIDTH * 0.7)).current;
            const [calcVisible, setCalcVisible] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [amount, setAmount] = useState('');
            const [calcResult, setCalcResult] = useState(null);

            const theme = isDarkMode ? {
              bg: '#0F172A', card: '#1E293B', text: '#F8FAFC', subText: '#94A3B8', gold: '#F59E0B', green: '#10B981', red: '#EF4444', border: '#334155', modal: '#1E293B', input: '#334155', drawer: '#0F172A'
            } : {
              bg: '#F1F5F9', card: '#FFFFFF', text: '#1E293B', subText: '#64748B', gold: '#D97706', green: '#059669', red: '#DC2626', border: '#E2E8F0', modal: '#FFFFFF', input: '#F1F5F9', drawer: '#FFFFFF'
            };

            // --- AÃ‡ILIÅž MANTIÄžI ---
            useEffect(() => {
              // 1. Veri Ã§ekmeyi baÅŸlat (Arka planda)
              loadData();
              
              // 2. Saat ayarla
              const timer = setInterval(() => setCurrentTime(new Date().toLocaleTimeString('tr-TR')), 1000);
              
              // 3. 2 Saniye sonra Splash ekranÄ±nÄ± ZORLA kapat.
              // Veri gelse de gelmese de bu Ã§alÄ±ÅŸÄ±r, o yÃ¼zden takÄ±lmaz.
              const splashTimer = setTimeout(() => {
                setShowFakeSplash(false);
              }, 2000);

              return () => { clearInterval(timer); clearTimeout(splashTimer); };
            }, []);

            const loadData = async () => {
              try {
                 const resp = await fetch(URL, { headers: { 'Cache-Control': 'no-cache' } });
                 const json = await resp.json();
                 if(Array.isArray(json)) {
                    setData(json);
                    const map = {}; json.forEach(i => map[i.k] = parseFloat(i.s)); setPrevData(map);
                 }
              } catch(e) { console.log(e); } finally { 
                 setLoading(false); 
                 setRefreshing(false); 
              }
            };
            
            const onRefresh = () => { setRefreshing(true); loadData(); };

            const toggleMenu = () => {
              if (menuVisible) {
                Animated.timing(slideAnim, { toValue: -SCREEN_WIDTH * 0.7, duration: 300, useNativeDriver: true }).start(() => setMenuVisible(false));
              } else {
                setMenuVisible(true);
                Animated.timing(slideAnim, { toValue: 0, duration: 300, useNativeDriver: true }).start();
              }
            };

            const openCalculator = (item) => { setSelectedItem(item); setAmount(''); setCalcResult(null); setCalcVisible(true); };
            const handleCalculate = (text) => {
              setAmount(text);
              if (selectedItem && text) {
                const val = parseFloat(text.replace(',', '.'));
                const p = parseFloat(selectedItem.s);
                if (!isNaN(val)) setCalcResult((val * p).toFixed(2));
              }
            };

            const getTrendIcon = (symbol, s) => {
               const cur = parseFloat(s); const old = prevData[symbol];
               if(!old || isNaN(old)) return {n:'remove', c:theme.subText};
               if(cur > old) return {n:'caret-up', c:theme.green};
               if(cur < old) return {n:'caret-down', c:theme.red};
               return {n:'remove', c:theme.subText};
            };

            const renderItem = ({ item }) => {
              const trend = getTrendIcon(item.k, item.s);
              return (
                <TouchableOpacity onPress={() => openCalculator(item)} activeOpacity={0.7}>
                  <View style={[styles.card, { backgroundColor: theme.card, borderColor: theme.border }]}>
                    <View style={{flexDirection:'row', alignItems:'center'}}>
                       <View style={[styles.iconBox, { backgroundColor: isDarkMode ? 'rgba(245,158,11,0.2)' : 'rgba(217,119,6,0.1)' }]}>
                          <Text style={{fontSize:18, fontWeight:'bold', color: theme.gold}}>{item.k.replace('_',' ').charAt(0)}</Text>
                       </View>
                       <View>
                          <Text style={{color: theme.text, fontWeight:'bold', fontSize:16}}>{item.k.replace('_', ' ')}</Text>
                          <Text style={{color: theme.subText, fontSize:11}}>{item.t?.split(' ')[1]}</Text>
                       </View>
                    </View>
                    <View style={{alignItems:'flex-end'}}>
                       <View style={{flexDirection:'row', alignItems:'center'}}>
                          <Text style={{color: theme.text, fontSize:18, fontWeight:'bold', marginRight:5}}>{parseFloat(item.s).toFixed(2)}</Text>
                          <Ionicons name={trend.n} size={20} color={trend.c} />
                       </View>
                       <Text style={{color: theme.subText, fontSize:12}}>{t.buy}: {parseFloat(item.a).toFixed(2)}</Text>
                    </View>
                  </View>
                </TouchableOpacity>
              );
            };

            // --- FAKE SPLASH EKRANI (JS TARAFI) ---
            if (showFakeSplash) {
              return (
                <View style={{flex:1, backgroundColor:'#000000', justifyContent:'center', alignItems:'center', zIndex:9999}}>
                   <StatusBar barStyle="light-content" />
                   <Text style={{color:'#F59E0B', fontSize:32, fontWeight:'900', letterSpacing:2}}>ANLIK PÄ°YASA</Text>
                   <View style={{marginTop:20}}>
                      <ActivityIndicator size="small" color="#F59E0B" />
                   </View>
                </View>
              );
            }

            // --- ANA EKRAN ---
            return (
              <View style={[styles.container, { backgroundColor: theme.bg, paddingTop: insets.top }]}>
                <StatusBar barStyle={isDarkMode ? "light-content" : "dark-content"} />
                
                <View style={[styles.header, { borderBottomColor: theme.border }]}>
                   <View style={{flexDirection:'row', alignItems:'center'}}>
                     <TouchableOpacity onPress={toggleMenu} style={{marginRight:15}}>
                        <Ionicons name="menu" size={28} color={theme.text} />
                     </TouchableOpacity>
                     <Text style={[styles.title, { color: theme.text }]}>{t.title} <Text style={{color: theme.gold}}>{t.titlePro}</Text></Text>
                   </View>
                   <View style={{flexDirection:'row', alignItems:'center'}}>
                      <Text style={[styles.clock, { color: theme.gold, backgroundColor: isDarkMode ? '#1E293B' : '#E2E8F0' }]}>{currentTime}</Text>
                   </View>
                </View>

                {loading && data.length === 0 ? <ActivityIndicator size="large" color={theme.gold} style={{marginTop:20}} /> : (
                  <FlatList
                    data={data} keyExtractor={item => item.k} renderItem={renderItem}
                    refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={theme.gold} />}
                    contentContainerStyle={{paddingBottom: 60}}
                  />
                )}

                <View style={{alignItems:'center', borderTopWidth:1, borderColor:theme.border, padding: 10, paddingBottom: Platform.OS === 'ios' ? insets.bottom + 5 : 10, backgroundColor: isDarkMode ? '#000' : '#eee' }}>
                  <Text style={{color: theme.subText, fontSize:9, marginBottom:2}}>ID: {BANNER_ID.slice(0,8)}...</Text>
                  <View style={{width: 320, height: 50, backgroundColor: theme.card, borderWidth:1, borderColor: theme.border, justifyContent:'center', alignItems:'center', borderRadius:6}}>
                     <Text style={{color: theme.gold, fontWeight:'bold', fontSize:12}}>{t.adSpace}</Text>
                  </View>
                </View>

                {menuVisible && (
                   <TouchableOpacity activeOpacity={1} onPress={toggleMenu} style={styles.menuOverlay}>
                      <Animated.View style={[styles.sideMenu, { transform: [{ translateX: slideAnim }], backgroundColor: theme.drawer }]}> 
                         <View style={{marginTop: insets.top + 20, paddingHorizontal: 20}}>
                            <Text style={{color: theme.text, fontSize:24, fontWeight:'bold', marginBottom:30}}>{t.settings}</Text>
                            <Text style={{color: theme.subText, fontSize:14, marginBottom:10}}>{t.language}</Text>
                            <View style={{flexDirection:'row', gap:10, marginBottom:30}}>
                               <TouchableOpacity onPress={() => setUserLang('tr')} style={[styles.langBtn, userLang === 'tr' && {borderColor: theme.gold, borderWidth:1}]}>
                                  <Text style={{color: theme.text}}>TR</Text>
                               </TouchableOpacity>
                               <TouchableOpacity onPress={() => setUserLang('en')} style={[styles.langBtn, userLang === 'en' && {borderColor: theme.gold, borderWidth:1}]}>
                                  <Text style={{color: theme.text}}>EN</Text>
                               </TouchableOpacity>
                               <TouchableOpacity onPress={() => setUserLang('auto')} style={[styles.langBtn, userLang === 'auto' && {borderColor: theme.gold, borderWidth:1}]}>
                                  <Text style={{color: theme.text}}>{t.auto}</Text>
                               </TouchableOpacity>
                            </View>
                            <Text style={{color: theme.subText, fontSize:14, marginBottom:10}}>{t.theme}</Text>
                            <View style={{flexDirection:'row', alignItems:'center', justifyContent:'space-between', backgroundColor: theme.card, padding:15, borderRadius:12}}>
                               <Text style={{color: theme.text}}>{isDarkMode ? "KaranlÄ±k Mod" : "AydÄ±nlÄ±k Mod"}</Text>
                               <TouchableOpacity onPress={() => setIsDarkMode(!isDarkMode)}>
                                  <Ionicons name={isDarkMode ? "moon" : "sunny"} size={26} color={theme.gold} />
                                </TouchableOpacity>
                            </View>
                         </View>
                      </Animated.View>
                   </TouchableOpacity>
                )}

                <Modal visible={calcVisible} transparent={true} animationType="slide" onRequestClose={() => setCalcVisible(false)}>
                  <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={styles.modalOverlay}>
                    <TouchableOpacity style={{flex:1, justifyContent:'center', alignItems:'center', width:'100%'}} activeOpacity={1} onPress={Keyboard.dismiss}>
                       <View style={[styles.calcContent, { backgroundColor: theme.modal, borderColor: theme.gold }]}>
                          <View style={{flexDirection:'row', justifyContent:'space-between', marginBottom:20}}>
                             <Text style={{color:theme.text, fontSize:18, fontWeight:'bold'}}>{t.calcTitle}</Text>
                             <TouchableOpacity onPress={() => setCalcVisible(false)}><Ionicons name="close-circle" size={30} color={theme.red} /></TouchableOpacity>
                          </View>
                          <Text style={{color: theme.gold, fontSize:22, fontWeight:'bold', marginBottom:15}}>{selectedItem?.s} â‚º</Text>
                          <TextInput 
                             style={[styles.input, { backgroundColor: theme.input, color: theme.text, borderColor: theme.border }]}
                             placeholder={t.amount} placeholderTextColor={theme.subText} keyboardType="numeric"
                             value={amount} onChangeText={handleCalculate}
                          />
                          {calcResult && (
                             <View style={{marginTop:20, padding:15, backgroundColor: theme.green, borderRadius:12, alignItems:'center'}}>
                                <Text style={{color:'#FFF', fontSize:12, opacity:0.8}}>{t.result}</Text>
                                <Text style={{color:'#FFF', fontSize:26, fontWeight:'900'}}>{calcResult} â‚º</Text>
                             </View>
                          )}
                       </View>
                    </TouchableOpacity>
                  </KeyboardAvoidingView>
                </Modal>
              </View>
            );
          }
          export default function App() { return <SafeAreaProvider><MainApp /></SafeAreaProvider>; }
          
          const styles = StyleSheet.create({
            container: { flex: 1 }, header: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', padding: 15, borderBottomWidth: 1 },
            title: { fontSize: 20, fontWeight: '800' }, clock: { fontSize: 13, fontWeight: 'bold', padding: 6, borderRadius: 6, overflow: 'hidden' },
            card: { flexDirection: 'row', justifyContent: 'space-between', padding: 16, marginHorizontal: 16, marginBottom: 10, borderRadius: 16, borderWidth: 1 },
            iconBox: { width: 42, height: 42, borderRadius: 12, justifyContent:'center', alignItems:'center', marginRight:12 },
            modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.7)', justifyContent: 'center' },
            calcContent: { width: '90%', padding: 20, borderRadius: 24, borderWidth: 1, elevation: 10 },
            input: { height: 50, borderRadius: 12, paddingHorizontal: 15, borderWidth: 1, fontSize: 18 },
            menuOverlay: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 1000 },
            sideMenu: { position: 'absolute', top: 0, bottom: 0, left: 0, width: '70%', shadowColor: "#000", shadowOpacity: 0.5, shadowRadius: 10, elevation: 10 },
            langBtn: { padding: 10, backgroundColor: 'rgba(128,128,128,0.2)', borderRadius: 8, minWidth: 50, alignItems: 'center' }
          });
          EOF

      # 6. APP.JSON
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "ANLIK PÄ°YASA",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "automatic",
              "icon": "./assets/icon.png",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#000000"
              },
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "supportsTablet": true,
                "infoPlist": {
                  "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true }
                }
              },
              "android": {
                "package": "com.piyasapro.app",
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#000000"
                }
              },
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": { "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" } }
            }
          }
          EOF

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      - name: ðŸš€ GÃ¼ncelle (Full Reset)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "Full Reset & Safe Splash" --non-interactive
