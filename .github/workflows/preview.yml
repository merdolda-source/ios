name: Expo Preview SDK 54 Full Fix

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TEMÄ°ZLÄ°K: Eski sÃ¼rÃ¼mlerle Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in her ÅŸeyi sÄ±fÄ±rlÄ±yoruz
      - name: ðŸ§¹ Ã–n Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets

      # 2. NODE KURULUMU: Yeni SDK'lar iÃ§in Node 20+ gereklidir
      - name: ðŸ— Node.js Kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. PACKAGE.JSON: SDK 54 iÃ§in tÃ¼m baÄŸÄ±mlÄ±lÄ±klar ve React 19 uyumu
      - name: ðŸ“„ package.json OluÅŸtur (SDK 54)
        run: |
          echo '{
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "scripts": {
              "start": "expo start",
              "android": "expo start --android",
              "ios": "expo start --ios"
            },
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-av": "~17.0.0",
              "expo-keep-awake": "~15.0.0",
              "expo-status-bar": "~2.1.0",
              "expo-asset": "~13.0.0",
              "expo-constants": "~19.0.0",
              "expo-font": "~15.0.0",
              "expo-updates": "~0.28.0",
              "expo-modules-core": "~2.3.0",
              "@expo/vector-icons": "~14.0.0",
              "@react-native-async-storage/async-storage": "2.1.0",
              "@react-navigation/native": "^7.0.0",
              "@react-navigation/stack": "^7.0.0",
              "@react-navigation/bottom-tabs": "^7.0.0",
              "react-native-safe-area-context": "5.0.0",
              "react-native-screens": "~5.0.0",
              "react-native-gesture-handler": "~2.22.0",
              "react-native-reanimated": "~4.0.0"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }' > package.json

      # 4. BABEL CONFIG: Modern derleme ayarlarÄ±
      - name: ðŸ“„ babel.config.js OluÅŸtur
        run: |
          echo "module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
              plugins: ['react-native-reanimated/plugin'],
            };
          };" > babel.config.js

      # 5. APP.JSON: SDK 54 uyumlu ayarlar ve Project ID
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          echo '{
            "expo": {
              "name": "eminxtream",
              "slug": "eminxtream",
              "owner": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "dark",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#050710"
              },
              "ios": { "supportsTablet": true, "bundleIdentifier": "com.eminxtream.app" },
              "android": { "package": "com.eminxtream.app" },
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": {
                "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" }
              }
            }
          }' > app.json

      # 6. ASSETS: Eksik resimlerden dolayÄ± build Ã§Ã¶kmesini engeller
      - name: ðŸ–¼ Sahte VarlÄ±klar (Assets) OluÅŸtur
        run: |
          mkdir -p assets
          touch assets/icon.png assets/splash.png assets/adaptive-icon.png assets/favicon.png

      # 7. KURULUM VE GÃ–NDERÄ°M
      - name: ðŸ“¦ CLI ve Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install

      - name: ðŸš€ Expo EAS Update (SDK 54)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas update --branch preview --message "Upgrade to SDK 54" --non-interactive
