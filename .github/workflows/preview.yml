name: Expo Preview

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # ADIM 1: Temizlik (Ã‡akÄ±ÅŸmalarÄ± Ã¶nlemek iÃ§in eski ayarlarÄ± siliyoruz)
      - name: ğŸ§¹ Temizlik ve HazÄ±rlÄ±k
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json

      - name: ğŸ— Node.js Kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ADIM 2: package.json (SDK 52 - iPhone 11 Expo Go ile tam uyumlu)
      # Gelecekteki sÃ¼rÃ¼m hatalarÄ±nÄ± Ã¶nlemek iÃ§in en gÃ¼ncel sÃ¼rÃ¼mleri kullanÄ±yoruz.
      - name: ğŸ“„ Create package.json (SDK 52)
        run: |
          echo '{
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "scripts": {
              "start": "expo start",
              "android": "expo start --android",
              "ios": "expo start --ios",
              "web": "expo start --web"
            },
            "dependencies": {
              "@react-native-async-storage/async-storage": "1.23.1",
              "@react-navigation/bottom-tabs": "^6.5.11",
              "@react-navigation/native": "^6.1.9",
              "@react-navigation/stack": "^6.3.20",
              "expo": "~52.0.25",
              "expo-av": "~15.0.2",
              "expo-keep-awake": "~14.0.2",
              "expo-status-bar": "~2.0.1",
              "react": "18.3.1",
              "react-native": "0.76.6",
              "react-native-safe-area-context": "4.12.0",
              "react-native-screens": "~4.4.0"
            },
            "devDependencies": {
              "@babel/core": "^7.20.0",
              "babel-preset-expo": "~12.0.0"
            },
            "private": true
          }' > package.json

      # ADIM 3: babel.config.js (Derleme hatalarÄ±nÄ± Ã¶nlemek iÃ§in ÅŸart)
      - name: ğŸ“„ Create babel.config.js
        run: |
          echo "module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
            };
          };" > babel.config.js

      # ADIM 4: app.json (Proje ID'sini buraya gÃ¶mÃ¼yoruz, bÃ¶ylece eas init hatasÄ± almÄ±yoruz)
      - name: ğŸ“„ Create app.json with Project ID
        run: |
          echo '{
            "expo": {
              "name": "eminxtream",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "light",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#ffffff"
              },
              "ios": { "supportsTablet": true },
              "android": { "adaptiveIcon": { "foregroundImage": "./assets/adaptive-icon.png", "backgroundColor": "#ffffff" } },
              "web": { "favicon": "./assets/favicon.png" },
              "extra": {
                "eas": {
                  "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4"
                }
              }
            }
          }' > app.json

      # ADIM 5: eas.json (Update kanalÄ±nÄ± manuel ayarlÄ±yoruz)
      - name: ğŸ“„ Create eas.json
        run: |
          echo '{
            "build": {
              "preview": { "distribution": "internal" },
              "production": {}
            },
            "submit": { "production": {} },
            "update": {
              "preview": { "channel": "preview" }
            }
          }' > eas.json

      - name: ğŸ“¦ EAS CLI YÃ¼kle
        run: npm install -g eas-cli

      - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
        run: npm install

      # ADIM 6: GÃ¼ncellemeyi GÃ¶nder
      # "eas init" komutunu kaldÄ±rdÄ±m Ã§Ã¼nkÃ¼ ADIM 4'te ID'yi zaten verdik. Bu hata riskini sÄ±fÄ±ra indirir.
      - name: ğŸš€ Expo'ya GÃ¶nder (Update)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas update --branch preview --message "Auto Repair & Update" --non-interactive
