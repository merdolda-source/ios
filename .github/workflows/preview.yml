name: EminXtream Pro Max UI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TEMÄ°ZLÄ°K
      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. PACKAGE.JSON
      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "fs-extra": "^11.2.0",
              "@expo/vector-icons": "~14.0.0"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # 3. BABEL CONFIG
      - name: âš™ï¸ Babel Config OluÅŸtur
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
            };
          };
          EOF

      # 4. METRO CONFIG
      - name: âš™ï¸ Metro Config OluÅŸtur
        run: |
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config');
          const config = getDefaultConfig(__dirname);
          module.exports = config;
          EOF

      # 5. APP.JS (FULL Ã–ZELLÄ°KLÄ° KOD)
      - name: ðŸ“± App.js OluÅŸtur (Ultimate Pro)
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect, useRef } from 'react';
          import { 
            Text, View, FlatList, SafeAreaView, ActivityIndicator, 
            StatusBar, TouchableOpacity, StyleSheet, Modal, Dimensions, Platform 
          } from 'react-native';
          import { Ionicons } from '@expo/vector-icons'; // Ä°konlar iÃ§in

          const URL = "https://imdatgel.site/harem/piyasa_cache.json";
          const { width } = Dimensions.get('window');

          export default function App() {
            // --- STATE YÃ–NETÄ°MÄ° ---
            const [data, setData] = useState([]);
            const [prevData, setPrevData] = useState({}); // Ã–nceki fiyatlarÄ± tutmak iÃ§in (Ä°bre iÃ§in)
            const [loading, setLoading] = useState(true);
            const [isDarkMode, setIsDarkMode] = useState(true); // Gece/GÃ¼ndÃ¼z Modu
            const [currentTime, setCurrentTime] = useState(""); // CanlÄ± Saat
            
            // Reklam MantÄ±ÄŸÄ±
            const [refreshCount, setRefreshCount] = useState(0); // KaÃ§ kere veri Ã§ekildi?
            const [showInterstitial, setShowInterstitial] = useState(false); // GeÃ§iÅŸ reklamÄ± durumu

            // --- TEMA AYARLARI ---
            const theme = isDarkMode ? {
              bg: '#0F172A', card: '#1E293B', text: '#F8FAFC', subText: '#94A3B8',
              gold: '#F59E0B', green: '#10B981', red: '#EF4444', border: '#334155',
              banner: '#000000'
            } : {
              bg: '#F1F5F9', card: '#FFFFFF', text: '#1E293B', subText: '#64748B',
              gold: '#D97706', green: '#059669', red: '#DC2626', border: '#E2E8F0',
              banner: '#E2E8F0'
            };

            // --- 1. CANLI SAAT MANTIÄžI (Saniye Saniye) ---
            useEffect(() => {
              const timer = setInterval(() => {
                const now = new Date();
                setCurrentTime(now.toLocaleTimeString('tr-TR'));
              }, 1000);
              return () => clearInterval(timer);
            }, []);

            // --- 2. VERÄ° Ã‡EKME & 30 SANÄ°YE DÃ–NGÃœSÃœ ---
            const loadData = async (isAutoRefresh = false) => {
              if (!isAutoRefresh) setLoading(true);
              
              try {
                const resp = await fetch(URL, { headers: { 'Cache-Control': 'no-cache' } });
                const json = await resp.json();
                
                if (Array.isArray(json)) {
                  // Ä°breler iÃ§in Ã¶nceki datayÄ± kaydet
                  setData(currentData => {
                    const priceMap = {};
                    currentData.forEach(item => {
                      priceMap[item.k] = parseFloat(item.s);
                    });
                    setPrevData(priceMap);
                    return json;
                  });

                  // Reklam SayacÄ± (4 seferde 1)
                  setRefreshCount(prev => {
                    const newVal = prev + 1;
                    if (newVal % 4 === 0) {
                      setTimeout(() => setShowInterstitial(true), 1000); // Biraz gecikmeli aÃ§
                    }
                    return newVal;
                  });
                }
              } catch (e) {
                console.error(e);
              } finally {
                setLoading(false);
              }
            };

            // Ä°lk aÃ§Ä±lÄ±ÅŸta ve her 30 saniyede bir Ã§alÄ±ÅŸÄ±r
            useEffect(() => {
              loadData(); // Ä°lk Ã§ekiÅŸ
              const interval = setInterval(() => {
                loadData(true); // 30 saniyede bir sessiz gÃ¼ncelleme
              }, 30000);
              return () => clearInterval(interval);
            }, []);

            // --- Ä°BRE MANTIÄžI (YÃ¼kseldi/DÃ¼ÅŸtÃ¼) ---
            const getTrendIcon = (symbol, currentPriceStr) => {
              const currentPrice = parseFloat(currentPriceStr);
              const oldPrice = prevData[symbol];

              if (!oldPrice) return { icon: 'remove', color: theme.subText }; // NÃ¶tr
              if (currentPrice > oldPrice) return { icon: 'caret-up', color: theme.green }; // YÃ¼kseliÅŸ
              if (currentPrice < oldPrice) return { icon: 'caret-down', color: theme.red }; // DÃ¼ÅŸÃ¼ÅŸ
              return { icon: 'remove', color: theme.subText }; // DeÄŸiÅŸmedi
            };

            // --- KART TASARIMI ---
            const renderItem = ({ item }) => {
              const trend = getTrendIcon(item.k, item.s);
              const symbolClean = item.k.replace('_', ' ');

              return (
                <View style={[styles.card, { backgroundColor: theme.card, borderColor: theme.border }]}>
                  {/* Sol Taraf: Ä°kon ve Ä°sim */}
                  <View style={{flexDirection:'row', alignItems:'center'}}>
                    <View style={[styles.iconBox, { backgroundColor: isDarkMode ? 'rgba(245,158,11,0.2)' : 'rgba(217,119,6,0.1)' }]}>
                      <Text style={{fontSize:18, fontWeight:'bold', color: theme.gold}}>
                        {symbolClean.charAt(0)}
                      </Text>
                    </View>
                    <View>
                      <Text style={{color: theme.text, fontWeight:'bold', fontSize:16}}>{symbolClean}</Text>
                      <Text style={{color: theme.subText, fontSize:11}}>{item.t?.split(' ')[1]}</Text>
                    </View>
                  </View>

                  {/* SaÄŸ Taraf: Fiyat ve Ä°bre */}
                  <View style={{alignItems:'flex-end'}}>
                    <View style={{flexDirection:'row', alignItems:'center'}}>
                      <Text style={{color: theme.text, fontSize:18, fontWeight:'bold', marginRight: 5}}>
                        {parseFloat(item.s).toFixed(2)}
                      </Text>
                      <Ionicons name={trend.icon} size={20} color={trend.color} />
                    </View>
                    <Text style={{color: theme.subText, fontSize:12}}>AlÄ±ÅŸ: {parseFloat(item.a).toFixed(2)}</Text>
                  </View>
                </View>
              );
            };

            return (
              <SafeAreaView style={[styles.container, { backgroundColor: theme.bg }]}>
                <StatusBar barStyle={isDarkMode ? "light-content" : "dark-content"} />

                {/* --- HEADER --- */}
                <View style={[styles.header, { borderBottomColor: theme.border }]}>
                  <View>
                    <Text style={[styles.headerTitle, { color: theme.text }]}>Piyasa<Text style={{color: theme.gold}}>Pro</Text></Text>
                    <Text style={{color: theme.subText, fontSize: 12}}>CanlÄ± Veri</Text>
                  </View>
                  
                  {/* SAAT ve MOD DEÄžÄ°ÅžTÄ°RME */}
                  <View style={{flexDirection:'row', alignItems:'center'}}>
                    <Text style={[styles.clock, { color: theme.gold, backgroundColor: isDarkMode ? '#1E293B' : '#E2E8F0' }]}>
                      {currentTime}
                    </Text>
                    <TouchableOpacity onPress={() => setIsDarkMode(!isDarkMode)} style={{marginLeft: 10, padding:5}}>
                      <Ionicons name={isDarkMode ? "sunny" : "moon"} size={24} color={theme.text} />
                    </TouchableOpacity>
                  </View>
                </View>

                {/* --- LÄ°STE --- */}
                {loading && !data.length ? (
                  <View style={styles.center}><ActivityIndicator size="large" color={theme.gold} /></View>
                ) : (
                  <FlatList
                    data={data}
                    keyExtractor={(item) => item.k}
                    renderItem={renderItem}
                    contentContainerStyle={{paddingBottom: 80, paddingTop: 10}}
                  />
                )}

                {/* --- BANNER REKLAM ALANI (TEST) --- */}
                <View style={[styles.bannerContainer, { backgroundColor: theme.banner, borderTopColor: theme.border }]}>
                  <Text style={{color: theme.subText, fontSize: 10, marginBottom: 2}}>AdMob Banner AlanÄ± (Test)</Text>
                  <View style={{width: 320, height: 50, backgroundColor: isDarkMode ? '#333' : '#CCC', justifyContent:'center', alignItems:'center'}}>
                    <Text style={{color: isDarkMode ? '#FFF' : '#000', fontWeight:'bold'}}>BANNER REKLAM</Text>
                  </View>
                </View>

                {/* --- GEÃ‡Ä°Åž REKLAMI (MODAL) --- */}
                <Modal visible={showInterstitial} transparent={true} animationType="slide">
                  <View style={styles.modalOverlay}>
                    <View style={[styles.interstitialBox, { backgroundColor: theme.card }]}>
                      <View style={{flexDirection:'row', justifyContent:'flex-end'}}>
                         <TouchableOpacity onPress={() => setShowInterstitial(false)} style={styles.closeBtn}>
                           <Ionicons name="close" size={24} color="#FFF" />
                         </TouchableOpacity>
                      </View>
                      <View style={{flex:1, justifyContent:'center', alignItems:'center'}}>
                        <Text style={{color: theme.text, fontSize:20, fontWeight:'bold', marginBottom:10}}>GEÃ‡Ä°Åž REKLAMI (TEST)</Text>
                        <Text style={{color: theme.subText, textAlign:'center'}}>
                          BurasÄ± AdMob Interstitial alanÄ±.{"\n"}4. veri Ã§ekiÅŸinde otomatik aÃ§Ä±ldÄ±.
                        </Text>
                        <ActivityIndicator size="large" color={theme.gold} style={{marginTop:20}} />
                      </View>
                    </View>
                  </View>
                </Modal>

              </SafeAreaView>
            );
          }

          const styles = StyleSheet.create({
            container: { flex: 1 },
            center: { flex: 1, justifyContent: 'center', alignItems: 'center' },
            header: {
              flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center',
              paddingHorizontal: 20, paddingVertical: 15, borderBottomWidth: 1
            },
            headerTitle: { fontSize: 24, fontWeight: '800' },
            clock: {
              fontSize: 14, fontWeight: 'bold', paddingHorizontal: 10, paddingVertical: 5,
              borderRadius: 8, overflow: 'hidden'
            },
            card: {
              flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center',
              padding: 16, marginHorizontal: 16, marginBottom: 12, borderRadius: 16,
              borderWidth: 1, shadowColor: "#000", shadowOffset: {width:0, height:2}, shadowOpacity:0.1, elevation:3
            },
            iconBox: { width: 40, height: 40, borderRadius: 12, justifyContent:'center', alignItems:'center', marginRight:12 },
            
            // Banner
            bannerContainer: {
              position: 'absolute', bottom: 0, width: '100%', height: 70,
              justifyContent: 'center', alignItems: 'center', borderTopWidth: 1,
              paddingBottom: Platform.OS === 'ios' ? 15 : 0
            },
            
            // Modal (GeÃ§iÅŸ ReklamÄ±)
            modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.8)', justifyContent: 'center', alignItems: 'center' },
            interstitialBox: { width: '90%', height: '60%', borderRadius: 20, padding: 20 },
            closeBtn: { backgroundColor: '#EF4444', borderRadius: 20, padding: 5 }
          });
          EOF

      # 6. APP.JSON
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "Piyasa Pro",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "automatic",
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "infoPlist": {
                  "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true }
                }
              },
              "android": {
                "package": "com.piyasapro.app"
              },
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": { "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" } }
            }
          }
          EOF

      - name: ðŸ–¼ Assets OluÅŸtur
        run: |
          mkdir -p assets
          touch assets/icon.png assets/splash.png assets/adaptive-icon.png assets/favicon.png

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      - name: ðŸš€ GÃ¶nder
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "Full Pro Features" --non-interactive
