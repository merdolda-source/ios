name: ANLIK PÄ°YASA - FINANS CEPTE MODE

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TEMÄ°ZLÄ°K
      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist credentials.json

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. GÃ–RSELLERÄ° HAZIRLA
      - name: ðŸŽ¨ GÃ¶rselleri OluÅŸtur
        run: |
          sudo apt-get install imagemagick -y
          mkdir -p assets
          
          # Ä°konu Ä°ndir
          curl -L -o assets/icon.png "https://i.ibb.co/99mj6zkx/71cf52be-22d6-4382-8a4e-bb42ea43796e.png"
          
          # Splash EkranÄ± Ã‡iz (Mavi Tonlu - FinansCepte)
          convert -size 1242x2688 xc:"#F8F9FA" \
            -fill "#2563EB" -font DejaVu-Sans-Bold -gravity center -pointsize 80 -annotate 0 "FinansCepte" \
            assets/splash.png
            
          cp assets/icon.png assets/adaptive-icon.png
          cp assets/icon.png assets/favicon.png

      # 3. PACKAGE.JSON
      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "fs-extra": "^11.2.0",
              "@expo/vector-icons": "~14.0.0",
              "react-native-safe-area-context": "4.12.0",
              "react-native-reanimated": "~3.6.1"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # 4. BABEL & METRO CONFIG
      - name: âš™ï¸ Config DosyalarÄ±
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) { 
            api.cache(true); 
            return { 
              presets: ['babel-preset-expo']
            }; 
          };
          EOF
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config'); const config = getDefaultConfig(__dirname); module.exports = config;
          EOF

      # 5. APP.JS (YENÄ° TASARIM - CREATORAPP24 API)
      - name: ðŸ“± App.js OluÅŸtur
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect, useCallback } from 'react';
          import { 
            View, 
            Text, 
            FlatList, 
            StyleSheet, 
            TouchableOpacity, 
            SafeAreaView, 
            StatusBar, 
            RefreshControl, 
            Platform
          } from 'react-native';
          import { ArrowUpRight, ArrowDownRight, Search, Menu, Bell, Filter, Clock } from 'lucide-react-native';

          // --- SABÄ°T VERÄ°LER (Yedek) ---
          const DEFAULT_DATA = [
              { "kod": "USD", "isim": "Amerikan DolarÄ±", "alis": "34,2000", "satis": "34,2500", "degisim": "%0,15", "durum": "yukseliste", "son_guncelleme": "--:--" },
              { "kod": "EUR", "isim": "Euro", "alis": "37,1000", "satis": "37,1800", "degisim": "%-0,05", "durum": "dususte", "son_guncelleme": "--:--" },
              { "kod": "GA", "isim": "Gram AltÄ±n", "alis": "2950,00", "satis": "2965,00", "degisim": "%0,40", "durum": "yukseliste", "son_guncelleme": "--:--" },
          ];

          // --- RENK PALETÄ° ---
          const COLORS = {
            background: '#F8F9FA',
            cardBg: '#FFFFFF',
            textDark: '#1A1C23',
            textLight: '#6C757D',
            accent: '#2563EB', // Modern Mavi
            success: '#10B981', // YeÅŸil (YÃ¼kseliÅŸ)
            danger: '#EF4444', // KÄ±rmÄ±zÄ± (DÃ¼ÅŸÃ¼ÅŸ)
            border: '#E9ECEF',
            headerBg: '#FFFFFF'
          };

          export default function CurrencyApp() {
            const [data, setData] = useState(DEFAULT_DATA);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [lastUpdate, setLastUpdate] = useState('');

            // --- VERÄ° Ã‡EKME FONKSÄ°YONU ---
            const fetchData = useCallback(async () => {
              try {
                const response = await fetch('https://creatorapp24.com/pre.php');
                const json = await response.json();

                let newData = [];
                if (json.data && Array.isArray(json.data)) {
                  newData = json.data;
                } else if (Array.isArray(json)) {
                  newData = json;
                }

                if (newData.length > 0) {
                  setData(newData);
                  const now = new Date();
                  const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                  setLastUpdate(timeString);
                }

              } catch (error) {
                console.error("Veri Ã§ekme hatasÄ±:", error);
              } finally {
                setLoading(false);
                setRefreshing(false);
              }
            }, []);

            // --- OTOMATÄ°K GÃœNCELLEME ---
            useEffect(() => {
              fetchData(); 
              const intervalId = setInterval(() => {
                fetchData();
              }, 30000);
              return () => clearInterval(intervalId);
            }, [fetchData]);

            const onRefresh = () => {
              setRefreshing(true);
              fetchData();
            };

            // --- LÄ°STE ELEMANI (RENDER ITEM) ---
            const renderItem = ({ item, index }) => {
              const isUp = item.durum === 'yukseliste' || (item.degisim && !item.degisim.includes('-'));
              const statusColor = isUp ? COLORS.success : COLORS.danger;
              const Icon = isUp ? ArrowUpRight : ArrowDownRight;

              return (
                <View style={styles.cardContainer}>
                  <View style={styles.cardLeft}>
                    <View style={[styles.iconBox, { backgroundColor: isUp ? '#D1FAE5' : '#FEE2E2' }]}>
                       <Text style={[styles.currencySymbol, { color: statusColor }]}>
                         {item.kod ? item.kod.substring(0, 1) : '$'}
                       </Text>
                    </View>
                    <View style={styles.nameContainer}>
                      <Text style={styles.currencyCode}>{item.kod}</Text>
                      <Text style={styles.currencyName} numberOfLines={1}>{item.isim}</Text>
                    </View>
                  </View>

                  <View style={styles.cardRight}>
                    <Text style={styles.priceText}>{item.satis}</Text>
                    <View style={styles.changeContainer}>
                      <Icon size={14} color={statusColor} style={{ marginRight: 2 }} />
                      <Text style={[styles.changeText, { color: statusColor }]}>{item.degisim}</Text>
                    </View>
                  </View>
                </View>
              );
            };

            // --- HEADER BÄ°LEÅžENÄ° ---
            const ListHeader = () => (
              <View style={styles.headerContainer}>
                {/* Ãœst Bilgi KartÄ± */}
                <View style={styles.heroCard}>
                  <View>
                    <Text style={styles.heroTitle}>Piyasa Ã–zeti</Text>
                    <Text style={styles.heroSubtitle}>CanlÄ± DÃ¶viz KurlarÄ±</Text>
                  </View>
                  <View style={styles.updateBadge}>
                     <Clock size={12} color="#FFF" style={{marginRight:4}} />
                     <Text style={styles.updateText}>
                       {lastUpdate ? `GÃ¼ncel: ${lastUpdate}` : 'YÃ¼kleniyor...'}
                     </Text>
                  </View>
                </View>

                {/* Arama ve Filtre */}
                <View style={styles.searchRow}>
                  <View style={styles.searchBar}>
                    <Search size={20} color={COLORS.textLight} />
                    <Text style={styles.placeholderText}>DÃ¶viz veya AltÄ±n ara...</Text>
                  </View>
                  <TouchableOpacity style={styles.filterBtn}>
                    <Filter size={20} color={COLORS.accent} />
                  </TouchableOpacity>
                </View>
              </View>
            );

            return (
              <SafeAreaView style={styles.container}>
                <StatusBar barStyle="dark-content" backgroundColor={COLORS.background} />
                
                {/* Ãœst Bar */}
                <View style={styles.topBar}>
                  <TouchableOpacity style={styles.iconButton}>
                    <Menu size={24} color={COLORS.textDark} />
                  </TouchableOpacity>
                  <Text style={styles.appTitle}>FinansCepte</Text>
                  <TouchableOpacity style={styles.iconButton}>
                    <Bell size={24} color={COLORS.textDark} />
                  </TouchableOpacity>
                </View>

                <FlatList
                  data={data}
                  renderItem={renderItem}
                  keyExtractor={(item, index) => item.kod + index}
                  contentContainerStyle={styles.listContent}
                  ListHeaderComponent={ListHeader}
                  refreshControl={
                    <RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={COLORS.accent} />
                  }
                  showsVerticalScrollIndicator={false}
                />
              </SafeAreaView>
            );
          }

          const styles = StyleSheet.create({
            container: {
              flex: 1,
              backgroundColor: COLORS.background,
              paddingTop: Platform.OS === 'android' ? 30 : 0
            },
            topBar: {
              flexDirection: 'row',
              justifyContent: 'space-between',
              alignItems: 'center',
              paddingHorizontal: 20,
              paddingVertical: 15,
              backgroundColor: COLORS.background,
            },
            appTitle: {
              fontSize: 20,
              fontWeight: '700',
              color: COLORS.textDark,
              letterSpacing: 0.5,
            },
            iconButton: {
              padding: 8,
              borderRadius: 12,
              backgroundColor: '#FFFFFF',
              shadowColor: "#000",
              shadowOffset: { width: 0, height: 2 },
              shadowOpacity: 0.05,
              shadowRadius: 3,
              elevation: 2,
            },
            listContent: {
              paddingBottom: 30,
            },
            headerContainer: {
              paddingHorizontal: 20,
              marginBottom: 10,
            },
            heroCard: {
              backgroundColor: COLORS.accent,
              borderRadius: 24,
              padding: 24,
              marginBottom: 20,
              flexDirection: 'row',
              justifyContent: 'space-between',
              alignItems: 'flex-start',
              shadowColor: COLORS.accent,
              shadowOffset: { width: 0, height: 8 },
              shadowOpacity: 0.3,
              shadowRadius: 12,
              elevation: 8,
            },
            heroTitle: {
              color: 'rgba(255,255,255,0.8)',
              fontSize: 14,
              fontWeight: '600',
              marginBottom: 4,
            },
            heroSubtitle: {
              color: '#FFFFFF',
              fontSize: 22,
              fontWeight: '800',
            },
            updateBadge: {
              flexDirection: 'row',
              alignItems: 'center',
              backgroundColor: 'rgba(255,255,255,0.2)',
              paddingHorizontal: 10,
              paddingVertical: 6,
              borderRadius: 20,
            },
            updateText: {
              color: '#FFFFFF',
              fontSize: 12,
              fontWeight: '600',
            },
            searchRow: {
              flexDirection: 'row',
              gap: 12,
            },
            searchBar: {
              flex: 1,
              flexDirection: 'row',
              alignItems: 'center',
              backgroundColor: '#FFFFFF',
              paddingHorizontal: 16,
              height: 50,
              borderRadius: 16,
              borderWidth: 1,
              borderColor: COLORS.border,
            },
            placeholderText: {
              marginLeft: 10,
              color: COLORS.textLight,
              fontSize: 15,
            },
            filterBtn: {
              width: 50,
              height: 50,
              backgroundColor: '#FFFFFF',
              borderRadius: 16,
              justifyContent: 'center',
              alignItems: 'center',
              borderWidth: 1,
              borderColor: COLORS.border,
            },
            cardContainer: {
              flexDirection: 'row',
              justifyContent: 'space-between',
              alignItems: 'center',
              backgroundColor: COLORS.cardBg,
              marginHorizontal: 20,
              marginBottom: 12,
              padding: 16,
              borderRadius: 20,
              shadowColor: "#000",
              shadowOffset: { width: 0, height: 2 },
              shadowOpacity: 0.03,
              shadowRadius: 8,
              elevation: 2,
              borderWidth: 1,
              borderColor: 'rgba(0,0,0,0.02)',
            },
            cardLeft: {
              flexDirection: 'row',
              alignItems: 'center',
              flex: 1,
            },
            iconBox: {
              width: 48,
              height: 48,
              borderRadius: 14,
              justifyContent: 'center',
              alignItems: 'center',
              marginRight: 14,
            },
            currencySymbol: {
              fontSize: 20,
              fontWeight: '700',
            },
            nameContainer: {
              flex: 1,
            },
            currencyCode: {
              fontSize: 16,
              fontWeight: '700',
              color: COLORS.textDark,
              marginBottom: 2,
            },
            currencyName: {
              fontSize: 13,
              color: COLORS.textLight,
              fontWeight: '500',
            },
            cardRight: {
              alignItems: 'flex-end',
            },
            priceText: {
              fontSize: 17,
              fontWeight: '700',
              color: COLORS.textDark,
              marginBottom: 4,
            },
            changeContainer: {
              flexDirection: 'row',
              alignItems: 'center',
              backgroundColor: 'rgba(0,0,0,0.03)',
              paddingHorizontal: 8,
              paddingVertical: 4,
              borderRadius: 8,
            },
            changeText: {
              fontSize: 13,
              fontWeight: '600',
            },
          });
          EOF

      # 6. APP.JSON (DÃœZELTÄ°LDÄ°: "owner" alanÄ± eklendi)
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "FinansCepte",
              "slug": "eminxtream",
              "owner": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "light",
              "icon": "./assets/icon.png",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#F8F9FA"
              },
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "supportsTablet": true,
                "infoPlist": {
                  "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true }
                }
              },
              "android": {
                "package": "com.piyasapro.app",
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#F8F9FA"
                }
              },
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": { "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" } }
            }
          }
          EOF

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      - name: ðŸš€ GÃ¼ncelle (Update)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "New Design: Owner Fixed" --non-interactive
