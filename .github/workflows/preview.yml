name: ANLIK PÄ°YASA - DEVELOPER MODE (SAFE)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist credentials.json

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸŽ¨ GÃ¶rselleri OluÅŸtur
        run: |
          sudo apt-get install imagemagick -y
          mkdir -p assets
          
          curl -L -o assets/icon.png "https://i.ibb.co/99mj6zkx/71cf52be-22d6-4382-8a4e-bb42ea43796e.png"
          
          convert -size 1242x2688 xc:"#000000" \
            -fill "#F59E0B" -font DejaVu-Sans-Bold -gravity center -pointsize 100 -annotate 0 "ANLIK PÄ°YASA" \
            assets/splash.png
            
          cp assets/icon.png assets/adaptive-icon.png
          cp assets/icon.png assets/favicon.png

      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~52.0.0",
              "react": "18.3.1",
              "react-native": "0.76.3",
              "expo-status-bar": "~2.0.0",
              "@expo/vector-icons": "^14.0.0",
              "react-native-safe-area-context": "4.12.0"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~12.0.0"
            },
            "private": true
          }
          EOF

      - name: âš™ï¸ Config DosyalarÄ±
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) { api.cache(true); return { presets: ['babel-preset-expo'] }; };
          EOF
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config'); const config = getDefaultConfig(__dirname); module.exports = config;
          EOF

      - name: ðŸ“± App.js OluÅŸtur
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect } from 'react';
          import { 
            Text, View, FlatList, ActivityIndicator, StatusBar, TouchableOpacity, 
            StyleSheet, Modal, Platform, TextInput, Keyboard, RefreshControl, 
            KeyboardAvoidingView, Dimensions
          } from 'react-native';
          import { Ionicons } from '@expo/vector-icons';
          import { SafeAreaProvider, useSafeAreaInsets } from 'react-native-safe-area-context';

          const BANNER_ID = "ca-app-pub-2289573527937577/9217874142";
          const INTERSTITIAL_ID = "ca-app-pub-2289573527937577/6951577531";
          const URL = "https://imdatgel.site/harem/piyasa_cache.json";

          function MainApp() {
            const insets = useSafeAreaInsets();
            const [data, setData] = useState([]);
            const [prevData, setPrevData] = useState({});
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [currentTime, setCurrentTime] = useState("");
            const [showFakeInterstitial, setShowFakeInterstitial] = useState(false);
            const [refreshCount, setRefreshCount] = useState(0);
            const [calcVisible, setCalcVisible] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [amount, setAmount] = useState('');
            const [calcResult, setCalcResult] = useState(null);
            const [error, setError] = useState(null);

            const theme = isDarkMode ? {
              bg: '#0F172A', card: '#1E293B', text: '#F8FAFC', subText: '#94A3B8',
              gold: '#F59E0B', green: '#10B981', red: '#EF4444', border: '#334155',
              modal: '#1E293B', input: '#334155'
            } : {
              bg: '#F1F5F9', card: '#FFFFFF', text: '#1E293B', subText: '#64748B',
              gold: '#D97706', green: '#059669', red: '#DC2626', border: '#E2E8F0',
              modal: '#FFFFFF', input: '#F1F5F9'
            };

            useEffect(() => {
              const t = setInterval(() => setCurrentTime(new Date().toLocaleTimeString('tr-TR')), 1000);
              return () => clearInterval(t);
            }, []);

            const loadData = async (isAuto = false) => {
              if (!isAuto) setLoading(true);
              setError(null);
              try {
                const resp = await fetch(URL, { 
                  headers: { 'Cache-Control': 'no-cache' },
                  cache: 'no-store'
                });
                if (!resp.ok) throw new Error('Sunucu hatasÄ±: ' + resp.status);
                const json = await resp.json();
                if (Array.isArray(json) && json.length > 0) {
                  setData(c => {
                     const m = {}; c.forEach(i => { if(i && i.k && i.s) m[i.k] = parseFloat(i.s); }); 
                     setPrevData(m); 
                     return json;
                  });
                  if(isAuto) {
                    setRefreshCount(prev => {
                      const newVal = prev + 1;
                      if(newVal % 4 === 0) setShowFakeInterstitial(true);
                      return newVal;
                    });
                  }
                } else {
                  throw new Error('Veri boÅŸ veya hatalÄ±');
                }
              } catch (e) { 
                console.error('Veri yÃ¼kleme hatasÄ±:', e); 
                setError(e.message);
              } finally { 
                setLoading(false); 
                setRefreshing(false); 
              }
            };

            useEffect(() => { 
              loadData(); 
              const i = setInterval(() => loadData(true), 30000); 
              return () => clearInterval(i); 
            }, []);
            
            const onRefresh = () => { setRefreshing(true); loadData(true); };

            const openCalculator = (item) => {
              if(!item) return;
              setSelectedItem(item); 
              setAmount(''); 
              setCalcResult(null); 
              setCalcVisible(true);
            };

            const handleCalculate = (text) => {
              setAmount(text);
              if (selectedItem && text && selectedItem.s) {
                const val = parseFloat(text.replace(',', '.'));
                const p = parseFloat(selectedItem.s);
                if (!isNaN(val) && !isNaN(p)) setCalcResult((val * p).toFixed(2));
                else setCalcResult(null);
              } else {
                setCalcResult(null);
              }
            };

            const getTrendIcon = (symbol, s) => {
               if(!symbol || !s) return {n:'remove', c:theme.subText};
               const cur = parseFloat(s); 
               const old = prevData[symbol];
               if(!old || isNaN(cur)) return {n:'remove', c:theme.subText};
               if(cur > old) return {n:'caret-up', c:theme.green};
               if(cur < old) return {n:'caret-down', c:theme.red};
               return {n:'remove', c:theme.subText};
            };

            const renderItem = ({ item }) => {
              if(!item || !item.k) return null;
              const trend = getTrendIcon(item.k, item.s);
              const salePrice = item.s ? parseFloat(item.s).toFixed(2) : '0.00';
              const buyPrice = item.a ? parseFloat(item.a).toFixed(2) : '0.00';
              const displayName = item.k.replace(/_/g, ' ');
              const firstChar = displayName.charAt(0).toUpperCase();
              const timeStr = item.t ? item.t.split(' ')[1] || '' : '';
              
              return (
                <TouchableOpacity onPress={() => openCalculator(item)} activeOpacity={0.7}>
                  <View style={[styles.card, { backgroundColor: theme.card, borderColor: theme.border }]}>
                    <View style={styles.cardLeft}>
                       <View style={[styles.iconBox, { backgroundColor: isDarkMode ? 'rgba(245,158,11,0.2)' : 'rgba(217,119,6,0.1)' }]}>
                          <Text style={[styles.iconText, {color: theme.gold}]}>{firstChar}</Text>
                       </View>
                       <View>
                          <Text style={[styles.itemName, {color: theme.text}]}>{displayName}</Text>
                          <Text style={[styles.itemTime, {color: theme.subText}]}>{timeStr}</Text>
                       </View>
                    </View>
                    <View style={styles.cardRight}>
                       <View style={styles.priceRow}>
                          <Text style={[styles.priceText, {color: theme.text}]}>{salePrice}</Text>
                          <Ionicons name={trend.n} size={20} color={trend.c} />
                       </View>
                       <Text style={[styles.buyText, {color: theme.subText}]}>AlÄ±ÅŸ: {buyPrice}</Text>
                    </View>
                  </View>
                </TouchableOpacity>
              );
            };

            return (
              <View style={[styles.container, { backgroundColor: theme.bg, paddingTop: insets.top }]}>
                <StatusBar barStyle={isDarkMode ? "light-content" : "dark-content"} />
                
                <View style={[styles.header, { borderBottomColor: theme.border }]}>
                   <Text style={[styles.title, { color: theme.text }]}>ANLIK <Text style={{color: theme.gold}}>PÄ°YASA</Text></Text>
                   <View style={styles.headerRight}>
                      <Text style={[styles.clock, { color: theme.gold, backgroundColor: isDarkMode ? '#1E293B' : '#E2E8F0' }]}>{currentTime}</Text>
                      <TouchableOpacity onPress={() => setIsDarkMode(!isDarkMode)} style={styles.themeBtn}>
                        <Ionicons name={isDarkMode ? "sunny" : "moon"} size={24} color={theme.text} />
                      </TouchableOpacity>
                   </View>
                </View>

                {error && (
                  <View style={[styles.errorBox, {backgroundColor: theme.red}]}>
                    <Ionicons name="warning" size={20} color="#FFF" />
                    <Text style={styles.errorText}>{error}</Text>
                  </View>
                )}

                {loading ? (
                  <View style={styles.loadingBox}>
                    <ActivityIndicator size="large" color={theme.gold} />
                    <Text style={[styles.loadingText, {color: theme.subText}]}>Veriler yÃ¼kleniyor...</Text>
                  </View>
                ) : (
                  <FlatList
                    data={data} 
                    keyExtractor={(item, index) => item?.k || index.toString()} 
                    renderItem={renderItem}
                    refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={theme.gold} colors={[theme.gold]} />}
                    contentContainerStyle={{paddingBottom: 80}}
                    ListEmptyComponent={
                      <View style={styles.emptyBox}>
                        <Text style={{color: theme.subText}}>Veri bulunamadÄ±</Text>
                      </View>
                    }
                  />
                )}

                <View style={[styles.bannerContainer, {borderTopColor: theme.border, backgroundColor: isDarkMode ? '#000' : '#eee', paddingBottom: Platform.OS === 'ios' ? insets.bottom + 10 : 10}]}>
                  <Text style={[styles.bannerLabel, {color: theme.subText}]}>REKLAM ALANI</Text>
                  <View style={[styles.bannerBox, {backgroundColor: theme.card, borderColor: theme.border}]}>
                     <Text style={[styles.bannerText, {color: theme.gold}]}>BANNER REKLAM YERÄ°</Text>
                  </View>
                </View>

                <Modal visible={showFakeInterstitial} transparent={true} animationType="fade">
                  <View style={styles.modalOverlay}>
                    <View style={[styles.interstitialBox, { backgroundColor: theme.card }]}>
                      <TouchableOpacity onPress={() => setShowFakeInterstitial(false)} style={styles.closeBtn}>
                         <Ionicons name="close" size={24} color="#FFF" />
                      </TouchableOpacity>
                      <View style={styles.interstitialContent}>
                        <Ionicons name="star" size={50} color={theme.gold} style={{marginBottom:10}} />
                        <Text style={[styles.interstitialTitle, {color: theme.text}]}>GEÃ‡Ä°Åž REKLAMI</Text>
                        <Text style={[styles.interstitialDesc, {color: theme.subText}]}>
                           Apple hesabÄ± onaylanÄ±nca burada gerÃ§ek reklam Ã§Ä±kacak.
                        </Text>
                      </View>
                    </View>
                  </View>
                </Modal>

                <Modal visible={calcVisible} transparent={true} animationType="slide" onRequestClose={() => setCalcVisible(false)}>
                  <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={styles.modalOverlay}>
                    <TouchableOpacity style={styles.calcOverlay} activeOpacity={1} onPress={Keyboard.dismiss}>
                       <View style={[styles.calcContent, { backgroundColor: theme.modal, borderColor: theme.gold }]}>
                          <View style={styles.calcHeader}>
                             <Text style={[styles.calcTitle, {color: theme.text}]}>Hesapla</Text>
                             <TouchableOpacity onPress={() => setCalcVisible(false)}>
                               <Ionicons name="close-circle" size={30} color={theme.red} />
                             </TouchableOpacity>
                          </View>
                          <Text style={[styles.calcPrice, {color: theme.gold}]}>
                            {selectedItem?.k?.replace(/_/g, ' ')}: {selectedItem?.s || '0'} â‚º
                          </Text>
                          <TextInput 
                             style={[styles.input, { backgroundColor: theme.input, color: theme.text, borderColor: theme.border }]}
                             placeholder="Miktar girin (gram/adet)" 
                             placeholderTextColor={theme.subText} 
                             keyboardType="decimal-pad"
                             value={amount} 
                             onChangeText={handleCalculate}
                          />
                          {calcResult && (
                             <View style={[styles.resultBox, {backgroundColor: theme.green}]}>
                                <Text style={styles.resultText}>{calcResult} â‚º</Text>
                             </View>
                          )}
                       </View>
                    </TouchableOpacity>
                  </KeyboardAvoidingView>
                </Modal>
              </View>
            );
          }
          
          export default function App() { 
            return (
              <SafeAreaProvider>
                <MainApp />
              </SafeAreaProvider>
            ); 
          }
          
          const styles = StyleSheet.create({
            container: { flex: 1 },
            header: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', padding: 15, borderBottomWidth: 1 },
            headerRight: { flexDirection: 'row', alignItems: 'center' },
            title: { fontSize: 22, fontWeight: '800' },
            clock: { fontSize: 13, fontWeight: 'bold', padding: 6, borderRadius: 6, overflow: 'hidden' },
            themeBtn: { marginLeft: 10 },
            card: { flexDirection: 'row', justifyContent: 'space-between', padding: 16, marginHorizontal: 16, marginBottom: 10, borderRadius: 16, borderWidth: 1 },
            cardLeft: { flexDirection: 'row', alignItems: 'center' },
            cardRight: { alignItems: 'flex-end' },
            iconBox: { width: 42, height: 42, borderRadius: 12, justifyContent: 'center', alignItems: 'center', marginRight: 12 },
            iconText: { fontSize: 18, fontWeight: 'bold' },
            itemName: { fontWeight: 'bold', fontSize: 16 },
            itemTime: { fontSize: 11 },
            priceRow: { flexDirection: 'row', alignItems: 'center' },
            priceText: { fontSize: 18, fontWeight: 'bold', marginRight: 5 },
            buyText: { fontSize: 12 },
            errorBox: { flexDirection: 'row', alignItems: 'center', padding: 10, margin: 10, borderRadius: 8 },
            errorText: { color: '#FFF', marginLeft: 8, flex: 1 },
            loadingBox: { flex: 1, justifyContent: 'center', alignItems: 'center' },
            loadingText: { marginTop: 10 },
            emptyBox: { flex: 1, justifyContent: 'center', alignItems: 'center', padding: 50 },
            bannerContainer: { alignItems: 'center', borderTopWidth: 1, padding: 10 },
            bannerLabel: { fontSize: 10, marginBottom: 4 },
            bannerBox: { width: 320, height: 50, borderWidth: 1, justifyContent: 'center', alignItems: 'center', borderRadius: 8 },
            bannerText: { fontWeight: 'bold' },
            modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.7)', justifyContent: 'center', alignItems: 'center' },
            calcOverlay: { flex: 1, justifyContent: 'center', alignItems: 'center', width: '100%' },
            calcContent: { width: '90%', padding: 20, borderRadius: 24, borderWidth: 1 },
            calcHeader: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 20 },
            calcTitle: { fontSize: 18, fontWeight: 'bold' },
            calcPrice: { fontSize: 22, fontWeight: 'bold', marginBottom: 15, textAlign: 'center' },
            input: { height: 50, borderRadius: 12, paddingHorizontal: 15, borderWidth: 1, fontSize: 18 },
            resultBox: { marginTop: 20, padding: 15, borderRadius: 12, alignItems: 'center' },
            resultText: { color: '#FFF', fontSize: 26, fontWeight: '900' },
            interstitialBox: { width: '85%', height: '50%', borderRadius: 20, padding: 20 },
            interstitialContent: { flex: 1, justifyContent: 'center', alignItems: 'center' },
            interstitialTitle: { fontSize: 20, fontWeight: 'bold', marginBottom: 10 },
            interstitialDesc: { textAlign: 'center' },
            closeBtn: { alignSelf: 'flex-end', backgroundColor: '#EF4444', borderRadius: 20, padding: 4 }
          });
          EOF

      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "ANLIK PÄ°YASA",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "automatic",
              "icon": "./assets/icon.png",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#000000"
              },
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "supportsTablet": true,
                "infoPlist": {
                  "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true }
                }
              },
              "android": {
                "package": "com.piyasapro.app",
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#000000"
                }
              },
              "updates": { 
                "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4"
              },
              "runtimeVersion": "1.0.0",
              "extra": { 
                "eas": { 
                  "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" 
                } 
              }
            }
          }
          EOF

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      - name: ðŸš€ GÃ¼ncelle (Update)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "SDK 52 Stable iOS Fix" --non-interactive
