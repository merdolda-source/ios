name: EminXtream Premium UI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Depoyu Ã‡ek
        uses: actions/checkout@v4

      # 1. TEMÄ°ZLÄ°K
      - name: ðŸ§¹ Derin Temizlik
        run: rm -rf node_modules package-lock.json package.json eas.json babel.config.js app.json assets metro.config.js App.js GoogleService-Info.plist

      - name: ðŸ— Node.js Kurulumu (v20)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 2. PACKAGE.JSON
      - name: ðŸ“„ package.json OluÅŸtur
        run: |
          cat > package.json <<'EOF'
          {
            "name": "eminxtream",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "dependencies": {
              "expo": "~54.0.0",
              "react": "19.0.0",
              "react-native": "0.78.0",
              "expo-status-bar": "~2.1.0",
              "expo-linear-gradient": "~14.0.0", 
              "fs-extra": "^11.2.0"
            },
            "devDependencies": {
              "@babel/core": "^7.25.0",
              "babel-preset-expo": "~13.0.0"
            },
            "private": true
          }
          EOF

      # 3. BABEL CONFIG
      - name: âš™ï¸ Babel Config OluÅŸtur
        run: |
          cat > babel.config.js <<'EOF'
          module.exports = function(api) {
            api.cache(true);
            return {
              presets: ['babel-preset-expo'],
            };
          };
          EOF

      # 4. METRO CONFIG
      - name: âš™ï¸ Metro Config OluÅŸtur
        run: |
          cat > metro.config.js <<'EOF'
          const { getDefaultConfig } = require('expo/metro-config');
          const config = getDefaultConfig(__dirname);
          module.exports = config;
          EOF

      # 5. APP.JS (PREMIUM TASARIM KODU)
      - name: ðŸ“± App.js OluÅŸtur (Premium UI)
        run: |
          cat > App.js <<'EOF'
          import React, { useState, useEffect, useCallback } from 'react';
          import { 
            Text, View, FlatList, SafeAreaView, ActivityIndicator, 
            StatusBar, TouchableOpacity, StyleSheet, Platform, RefreshControl 
          } from 'react-native';

          // RENK PALETÄ° (Premium Dark Theme)
          const COLORS = {
            bg: '#0F172A',       // Derin Gece Mavisi/SiyahÄ±
            card: '#1E293B',     // Kart Rengi
            gold: '#F59E0B',     // AltÄ±n/Amber Rengi
            text: '#F1F5F9',     // KÄ±rÄ±k Beyaz
            subText: '#94A3B8',  // Soluk Gri
            green: '#10B981',    // YÃ¼kseliÅŸ YeÅŸili
            border: '#334155'    // Ä°nce Ã‡erÃ§eve Rengi
          };

          const URL = "https://imdatgel.site/harem/piyasa_cache.json";

          export default function App() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [lastUpdate, setLastUpdate] = useState("");

            const loadData = useCallback(async () => {
              try {
                const resp = await fetch(URL, { headers: { 'Cache-Control': 'no-cache' } });
                const json = await resp.json();
                if (Array.isArray(json)) {
                  setData(json);
                  const now = new Date();
                  setLastUpdate(now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'}));
                }
              } catch (e) {
                console.error(e);
              } finally {
                setLoading(false);
                setRefreshing(false);
              }
            }, []);

            useEffect(() => { loadData(); }, []);

            const onRefresh = () => {
              setRefreshing(true);
              loadData();
            };

            // Ã–ZEL KART TASARIMI
            const renderItem = ({ item }) => {
              // Sembol ismini gÃ¼zelleÅŸtir (ALTIN -> AltÄ±n, USDTRY -> Dolar/TL gibi yapÄ±labilir ama ÅŸimdilik temizleyelim)
              const symbol = item.k.replace('_', ' ');
              const time = item.t?.split(' ')[1] || '--:--';
              
              return (
                <View style={styles.card}>
                  {/* SOL TARAF: Ä°SÄ°M VE SAAT */}
                  <View style={styles.leftInfo}>
                    <View style={styles.iconPlaceholder}>
                      <Text style={styles.iconText}>{symbol.substring(0,1)}</Text>
                    </View>
                    <View>
                      <Text style={styles.symbolName}>{symbol}</Text>
                      <Text style={styles.timeText}>ðŸ•’ {time}</Text>
                    </View>
                  </View>

                  {/* SAÄž TARAF: FÄ°YATLAR */}
                  <View style={styles.rightInfo}>
                    <Text style={styles.sellPrice}>{item.s} <Text style={styles.currency}>â‚º</Text></Text>
                    <View style={styles.buyBadge}>
                      <Text style={styles.buyLabel}>ALIÅž: </Text>
                      <Text style={styles.buyPrice}>{item.a}</Text>
                    </View>
                  </View>
                </View>
              );
            };

            return (
              <SafeAreaView style={styles.container}>
                <StatusBar barStyle="light-content" backgroundColor={COLORS.bg} />
                
                {/* HEADER ALANI */}
                <View style={styles.header}>
                  <View>
                    <Text style={styles.headerTitle}>Piyasa<Text style={{color: COLORS.gold}}>Pro</Text></Text>
                    <Text style={styles.headerSub}>CanlÄ± DÃ¶viz & AltÄ±n</Text>
                  </View>
                  <View style={styles.statusBadge}>
                    <View style={styles.dot} />
                    <Text style={styles.statusText}>{lastUpdate ? lastUpdate : '...'}</Text>
                  </View>
                </View>

                {/* LÄ°STE ALANI */}
                {loading ? (
                  <View style={styles.center}>
                    <ActivityIndicator size="large" color={COLORS.gold} />
                    <Text style={{color: COLORS.subText, marginTop: 10}}>Piyasa verileri alÄ±nÄ±yor...</Text>
                  </View>
                ) : (
                  <FlatList
                    data={data}
                    keyExtractor={(item, index) => index.toString()}
                    renderItem={renderItem}
                    contentContainerStyle={styles.listContent}
                    refreshControl={
                      <RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={COLORS.gold} />
                    }
                  />
                )}
              </SafeAreaView>
            );
          }

          const styles = StyleSheet.create({
            container: { flex: 1, backgroundColor: COLORS.bg },
            center: { flex: 1, justifyContent: 'center', alignItems: 'center' },
            
            // Header Stilleri
            header: {
              paddingHorizontal: 20,
              paddingVertical: 15,
              flexDirection: 'row',
              justifyContent: 'space-between',
              alignItems: 'center',
              borderBottomWidth: 1,
              borderBottomColor: COLORS.border,
              backgroundColor: COLORS.bg,
              marginBottom: 10
            },
            headerTitle: { fontSize: 28, fontWeight: '800', color: COLORS.text, letterSpacing: 0.5 },
            headerSub: { fontSize: 12, color: COLORS.subText, fontWeight: '500' },
            statusBadge: { 
              flexDirection: 'row', alignItems: 'center', backgroundColor: COLORS.card, 
              paddingHorizontal: 10, paddingVertical: 6, borderRadius: 20, borderWidth: 1, borderColor: COLORS.border 
            },
            dot: { width: 6, height: 6, borderRadius: 3, backgroundColor: COLORS.green, marginRight: 6 },
            statusText: { color: COLORS.text, fontSize: 12, fontWeight: 'bold' },

            // Liste Stilleri
            listContent: { paddingHorizontal: 16, paddingBottom: 20 },
            
            // Kart Stilleri
            card: {
              backgroundColor: COLORS.card,
              borderRadius: 16,
              padding: 16,
              marginBottom: 12,
              flexDirection: 'row',
              justifyContent: 'space-between',
              alignItems: 'center',
              // GÃ¶lge Efekti (iOS & Android)
              shadowColor: "#000",
              shadowOffset: { width: 0, height: 4 },
              shadowOpacity: 0.2,
              shadowRadius: 5,
              elevation: 4,
              borderWidth: 1,
              borderColor: COLORS.border
            },
            leftInfo: { flexDirection: 'row', alignItems: 'center' },
            iconPlaceholder: {
              width: 40, height: 40, borderRadius: 12, backgroundColor: 'rgba(245, 158, 11, 0.15)',
              justifyContent: 'center', alignItems: 'center', marginRight: 12
            },
            iconText: { color: COLORS.gold, fontSize: 18, fontWeight: 'bold' },
            symbolName: { fontSize: 16, fontWeight: '700', color: COLORS.text, marginBottom: 2 },
            timeText: { fontSize: 11, color: COLORS.subText },
            
            rightInfo: { alignItems: 'flex-end' },
            sellPrice: { fontSize: 18, fontWeight: 'bold', color: COLORS.text },
            currency: { fontSize: 14, color: COLORS.gold },
            buyBadge: { 
              flexDirection: 'row', marginTop: 4, backgroundColor: 'rgba(255,255,255,0.05)', 
              paddingHorizontal: 6, paddingVertical: 2, borderRadius: 4 
            },
            buyLabel: { fontSize: 10, color: COLORS.subText, fontWeight: '600' },
            buyPrice: { fontSize: 10, color: COLORS.text, fontWeight: '700' }
          });
          EOF

      # 6. APP.JSON
      - name: ðŸ“„ app.json OluÅŸtur
        run: |
          cat > app.json <<'EOF'
          {
            "expo": {
              "name": "Piyasa Pro",
              "slug": "eminxtream",
              "version": "1.0.0",
              "orientation": "portrait",
              "userInterfaceStyle": "dark",
              "ios": {
                "bundleIdentifier": "com.piyasapro.app",
                "infoPlist": {
                  "NSAppTransportSecurity": { "NSAllowsArbitraryLoads": true }
                }
              },
              "android": {
                "package": "com.piyasapro.app"
              },
              "updates": { "url": "https://u.expo.dev/7b7866e2-688e-4e87-af97-88213b2670d4" },
              "runtimeVersion": { "policy": "appVersion" },
              "extra": { "eas": { "projectId": "7b7866e2-688e-4e87-af97-88213b2670d4" } }
            }
          }
          EOF

      - name: ðŸ–¼ Assets OluÅŸtur
        run: |
          mkdir -p assets
          touch assets/icon.png assets/splash.png assets/adaptive-icon.png assets/favicon.png

      - name: ðŸ“¦ Paket Kurulumu
        run: |
          npm install -g eas-cli
          npm install --legacy-peer-deps

      - name: ðŸš€ GÃ¶nder
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas update --branch preview --message "New Premium Dark UI" --non-interactive
